<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard do Gestor - Sistema de Gestão de Desempenho</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 0;
        }
        .manager-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .team-select {
            background: #f8f9fa;
            border: 2px solid #17a2b8;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .evaluation-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .criteria-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .rating-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .rating-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #ddd;
            border-radius: 50%;
            background: white;
            color: #666;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .rating-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }
        .rating-btn.selected {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }
        .dimension-header {
            background: #667eea;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .type-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .type-desempenho {
            background: #28a745;
            color: white;
        }
        .type-potencial {
            background: #17a2b8;
            color: white;
        }
        .goals-section {
            background: #e8f4fd;
            border: 2px solid #17a2b8;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .goal-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #f9f9f9;
        }
        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .goal-header h4 {
            margin: 0;
            color: #2c3e50;
        }
        .goal-content {
            margin-bottom: 15px;
        }
        .goal-content input, .goal-content textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .goal-criteria {
            margin-bottom: 15px;
        }
        .goal-criteria h5 {
            margin-bottom: 10px;
            color: #34495e;
        }
        .criteria-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        .criteria-item {
            display: flex;
            flex-direction: column;
        }
        .criteria-item label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        .criteria-item textarea {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            min-height: 60px;
        }
        .goal-rating {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .goal-rating label {
            font-weight: bold;
            color: #2c3e50;
        }
        .goal-rating select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 200px;
        }
        .dimension-weights {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .final-rating {
            background: #d4edda;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        .final-rating-value {
            font-size: 2rem;
            font-weight: bold;
            color: #28a745;
        }
        .dimension-average {
            background-color: #e3f2fd;
            color: #1565c0;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            margin-left: 10px;
            font-size: 12px;
        }
        .weight-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }
        .weight-item label {
            min-width: 100px;
            font-weight: bold;
        }
        .total-weight {
            background: #28a745;
            color: white;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        .total-weight.invalid {
            background: #dc3545;
        }
    </style>
</head>
<body>
    <!-- Hero Section -->
    <section class="hero-section">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 mx-auto text-center">
                    <h1 class="display-4 fw-bold mb-4">Dashboard do Gestor</h1>
                    <p class="lead mb-4">Gerencie as avaliações do seu time</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Team Selection -->
    <section class="py-5">
        <div class="container">
            <div class="team-select">
                <h4><i class="fas fa-users me-2"></i>Selecionar Integrante do Time</h4>
                <div class="row">
                    <div class="col-md-6">
                        <label for="team-member-select" class="form-label"><strong>Funcionário:</strong></label>
                        <select id="team-member-select" class="form-select" onchange="loadTeamMemberEvaluation()">
                            <option value="">Selecione um funcionário...</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><strong>Status da Janela:</strong></label>
                        <div id="window-status" class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>Carregando status...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Employee Evaluation -->
    <section class="py-5" id="evaluation-section" style="display: none;">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <h2 class="text-center mb-5">Avaliação de Desempenho</h2>
                    
                    <!-- Employee Info -->
                    <div class="evaluation-section" id="employee-header">
                        <h4>Informações do Avaliado</h4>
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Nome:</strong> <span id="employee-name">-</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Cargo:</strong> <span id="employee-role">-</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Empresa:</strong> <span id="employee-company">-</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Gestor:</strong> <span id="employee-manager">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Round Code -->
                    <div class="evaluation-section" style="background: #e8f4fd; border: 2px solid #17a2b8;">
                        <h4><i class="fas fa-calendar-alt me-2"></i>Código da Rodada</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="round-code" class="form-label"><strong>Código da Rodada:</strong></label>
                                <input type="text" id="round-code" class="form-control" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Dimension Weights -->
                    <div class="dimension-weights">
                        <h3>Pesos das Dimensões</h3>
                        <div class="weight-inputs">
                            <div class="weight-item">
                                <label>INSTITUCIONAL:</label>
                                <input type="number" id="weight-institucional" min="0" max="100" value="">
                                <span>%</span>
                                <span class="dimension-average" id="avg-institucional">-</span>
                            </div>
                            <div class="weight-item">
                                <label>FUNCIONAL:</label>
                                <input type="number" id="weight-funcional" min="0" max="100" value="">
                                <span>%</span>
                                <span class="dimension-average" id="avg-funcional">-</span>
                            </div>
                            <div class="weight-item">
                                <label>INDIVIDUAL:</label>
                                <input type="number" id="weight-individual" min="0" max="100" value="">
                                <span>%</span>
                                <span class="dimension-average" id="avg-individual">-</span>
                            </div>
                            <div class="weight-item">
                                <label>METAS:</label>
                                <input type="number" id="weight-metas" min="0" max="100" value="">
                                <span>%</span>
                                <span class="dimension-average" id="avg-metas">-</span>
                            </div>
                        </div>
                        <div class="total-weight">
                            <strong>Total: <span id="total-weight">0</span>%</strong>
                        </div>
                    </div>

                    <!-- Evaluation Criteria -->
                    <div id="evaluation-criteria">
                        <!-- Os critérios serão carregados aqui -->
                    </div>

                    <!-- Goals Section -->
                    <div class="goals-section">
                        <h4><i class="fas fa-bullseye me-2"></i>Metas Individuais (3 a 5 metas)</h4>
                        <div id="goals-container">
                            <!-- As metas serão carregadas aqui -->
                        </div>
                        <div class="text-center mt-3">
                            <button class="btn btn-primary" onclick="addGoal()">
                                <i class="fas fa-plus me-2"></i>Adicionar Meta
                            </button>
                            <button class="btn btn-success ms-2" onclick="saveGoals()">
                                <i class="fas fa-save me-2"></i>Salvar Metas
                            </button>
                        </div>
                        <div class="total-weight mt-3">
                            <strong>Total: <span id="goals-total-weight">0</span>%</strong>
                        </div>
                    </div>

                    <!-- Final Rating -->
                    <div class="final-rating">
                        <h4>Rating Final</h4>
                        <div class="final-rating-value" id="final-rating">-</div>
                        <p class="mt-2">1 = Excelente | 2 = Superou | 3 = Atendeu | 4 = Não Atendeu | 5 = Insuficiente</p>
                    </div>

                    <!-- Action Buttons -->
                    <div class="text-center mt-4">
                        <button class="btn btn-success btn-lg" onclick="saveManagerEvaluation()" id="save-btn">
                            <i class="fas fa-save me-2"></i>Salvar Avaliação
                        </button>
                        <button class="btn btn-info btn-lg ms-3" onclick="viewNineBoxPosition()">
                            <i class="fas fa-th me-2"></i>Ver Posição 9-Box
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Estado global
        let currentEmployee = null;
        let evaluationData = {};
        let dimensionWeights = {};
        let isWindowOpen = false;
        let goals = [];

        // Carregar funcionários do time
        async function loadTeamMembers() {
            try {
                const response = await fetch('/api/employees');
                const employees = await response.json();
                
                const select = document.getElementById('team-member-select');
                select.innerHTML = '<option value="">Selecione um funcionário...</option>';
                
                employees.forEach(employee => {
                    const option = document.createElement('option');
                    option.value = employee.id;
                    option.textContent = `${employee.nome} - ${employee.cargo}`;
                    select.appendChild(option);
                });
            } catch (e) {
                console.error('Erro ao carregar funcionários:', e);
                alert('Erro ao carregar lista de funcionários');
            }
        }

        // Carregar status da janela
        async function loadWindowStatus() {
            try {
                const response = await fetch('/api/evaluations/window');
                const window = await response.json();
                
                const statusEl = document.getElementById('window-status');
                if (window.open) {
                    statusEl.className = 'alert alert-success';
                    statusEl.innerHTML = '<i class="fas fa-check-circle me-2"></i>Janela ABERTA - Alterações permitidas';
                    isWindowOpen = true;
                } else {
                    statusEl.className = 'alert alert-warning';
                    statusEl.innerHTML = '<i class="fas fa-lock me-2"></i>Janela FECHADA - Apenas visualização';
                    isWindowOpen = false;
                }
                
                // Habilitar/desabilitar campos baseado no status
                updateFieldAccess();
            } catch (e) {
                console.error('Erro ao carregar status da janela:', e);
            }
        }


        // Carregar código da rodada ativo
        async function loadActiveRoundCode() {
            try {
                const response = await fetch('/api/system-config');
                const config = await response.json();
                
                if (config.active_round_code) {
                    document.getElementById('round-code').value = config.active_round_code;
                } else {
                    document.getElementById('round-code').value = '';
                }
            } catch (e) {
                console.error('Erro ao carregar código da rodada:', e);
                document.getElementById('round-code').value = '';
            }
        }

        
        
        // Atualizar acesso aos campos
        function updateFieldAccess() {
            const inputs = document.querySelectorAll('input, select, button');
            const saveBtn = document.getElementById('save-btn');
            
            if (isWindowOpen) {
                inputs.forEach(input => input.disabled = false);
                saveBtn.style.display = 'inline-block';
            } else {
                inputs.forEach(input => {
                    if (input.id !== 'team-member-select') {
                        input.disabled = true;
                    }
                });
                saveBtn.style.display = 'none';
            }
        }

        }  // ← fim de updateFieldAccess()

        // Trava os inputs de peso para não serem editados pelo gestor
        function lockDWInputs(){
          ['weight-institucional','weight-funcional','weight-individual','weight-metas']
            .forEach(id=>{
              const el = document.getElementById(id);
              if(!el) return;
              el.readOnly = true;                // impede digitação
              el.setAttribute('tabindex','-1');  // evita foco pelo teclado
              el.title = 'Definido pelo RH';
              el.addEventListener('wheel', e=>e.preventDefault(), {passive:false}); // bloqueia rodinha
              el.addEventListener('keydown', e=>{
                if (['ArrowUp','ArrowDown','PageUp','PageDown','+','-'].includes(e.key)) e.preventDefault();
              });
            });
        }


        // Carregar avaliação do funcionário selecionado
        async function loadTeamMemberEvaluation() {
            const select = document.getElementById('team-member-select');
            const employeeId = select.value;
            
            if (!employeeId) {
                document.getElementById('evaluation-section').style.display = 'none';
                return;
            }

            try {
                // Buscar dados do funcionário
                const empResponse = await fetch('/api/employees');
                const employees = await empResponse.json();
                currentEmployee = employees.find(emp => emp.id == employeeId);
                
                if (!currentEmployee) {
                    alert('Funcionário não encontrado');
                    return;
                }

                // Preencher informações do funcionário
                document.getElementById('employee-name').textContent = currentEmployee.nome;
                document.getElementById('employee-role').textContent = currentEmployee.cargo;
                document.getElementById('employee-company').textContent = currentEmployee.empresa;
                document.getElementById('employee-manager').textContent = currentEmployee.manager_name || '-';

                // Carregar avaliação existente
                await loadExistingEvaluation(employeeId);
                
                // Mostrar seção
                document.getElementById('evaluation-section').style.display = 'block';
                document.getElementById('evaluation-section').scrollIntoView({behavior: 'smooth'});
                
            } catch (e) {
                console.error('Erro ao carregar avaliação:', e);
                alert('Erro ao carregar avaliação do funcionário');
            }
        }

        // Carregar avaliação existente
        async function loadExistingEvaluation(employeeId) {
            try {
                // Primeiro, carregar o código da rodada ativo
                await loadActiveRoundCode();
                
                const response = await fetch(`/api/evaluations/latest?employee_id=${employeeId}`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        // Não há avaliação - carregar formulário vazio
                        await loadEmptyEvaluation();
                        return;
                    }
                    throw new Error('Erro ao carregar avaliação');
                }
        
                const { evaluation, responses, weights, goals: savedGoals } = await response.json();
                
                // Carregar código da rodada (usar o ativo, não o salvo)
                // document.getElementById('round-code').value = evaluation.round_code || '';
                
                // Carregar critérios
                await loadEvaluationCriteria();
                
                // Marcar respostas
                evaluationData = {};
                (responses || []).forEach(row => {
                    const cid = String(row.criteria_id);
                    const r = Number(row.rating);
                    document.querySelectorAll(`[data-criteria="${cid}"]`).forEach(btn => btn.classList.remove('selected'));
                    const btn = document.querySelector(`[data-criteria="${cid}"][data-rating="${r}"]`);
                    if (btn) {
                        btn.classList.add('selected');
                        evaluationData[cid] = r;
                    }
                });
        
                // Carregar pesos das dimensões
                const savedWeights = weights || {};
                document.getElementById('weight-institucional').value = savedWeights.INSTITUCIONAL || 0;
                document.getElementById('weight-funcional').value = savedWeights.FUNCIONAL || 0;
                document.getElementById('weight-individual').value = savedWeights.INDIVIDUAL || 0;
                document.getElementById('weight-metas').value = savedWeights.METAS || 0;
                
                dimensionWeights = savedWeights;
                updateDimensionWeights();
                
                // Carregar metas
                if (savedGoals && savedGoals.length > 0) {
                    goals = savedGoals;
                    renderGoals();
                } else {
                    goals = [];
                    renderGoals();
                }
                
                calculateFinalRating();
                
            } catch (e) {
                console.error('Erro ao carregar avaliação existente:', e);
                await loadEmptyEvaluation();
            }
        }

        
        // Carregar formulário vazio
        async function loadEmptyEvaluation() {
            // Carregar código da rodada ativo
            await loadActiveRoundCode();
            
            await loadEvaluationCriteria();
            evaluationData = {};
            dimensionWeights = { INSTITUCIONAL: 0, FUNCIONAL: 0, INDIVIDUAL: 0, METAS: 0 };
            
            // Limpar campos de peso
            document.getElementById('weight-institucional').value = '';
            document.getElementById('weight-funcional').value = '';
            document.getElementById('weight-individual').value = '';
            document.getElementById('weight-metas').value = '';
            
            // Limpar totais
            document.getElementById('total-weight').textContent = '0';
            document.getElementById('goals-total-weight').textContent = '0';
            
            goals = [];
            renderGoals();
            calculateFinalRating();
        }

        
        // Carregar critérios de avaliação
        async function loadEvaluationCriteria() {
            try {
                const response = await fetch('/api/evaluation-criteria');
                const criteria = await response.json();
                const container = document.getElementById('evaluation-criteria');
                container.innerHTML = '';

                // Agrupar por dimensão
                const dimensions = {};
                criteria.forEach(c => {
                    const dim = (c.dimension || '').toUpperCase();
                    if (!dimensions[dim]) dimensions[dim] = [];
                    dimensions[dim].push(c);
                });

                Object.keys(dimensions).forEach(dimension => {
                    const section = document.createElement('div');
                    section.className = 'evaluation-section';

                    let html = `
                        <div class="dimension-header">
                            <h4>DIMENSÃO ${dimension}</h4>
                        </div>`;

                    dimensions[dimension].forEach(c => {
                        const typeClass = `type-${(c.type||'').toLowerCase()}`;
                        html += `
                            <div class="criteria-card" data-dimension="${dimension}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center gap-2 mb-2">
                                            <span class="type-badge ${typeClass}">${c.type}</span>
                                            <strong>${c.name}</strong>
                                        </div>
                                        <p class="text-muted mb-3">${c.description||''}</p>
                                    </div>
                                    <div class="rating-buttons">
                                        ${[1,2,3,4,5].map(r => `
                                            <button class="rating-btn" onclick="setRating(${c.id}, ${r})"
                                                    data-criteria="${c.id}" data-rating="${r}">
                                                ${r}
                                            </button>`).join('')}
                                    </div>
                                </div>
                            </div>`;
                    });

                    section.innerHTML = html;
                    container.appendChild(section);
                });
            } catch (e) {
                console.error('Erro ao carregar critérios:', e);
            }
        }

        // Renderizar metas
        function renderGoals() {
            const container = document.getElementById('goals-container');
            container.innerHTML = '';

            goals.forEach((goal, idx) => {
                const goalEl = document.createElement('div');
                goalEl.className = 'goal-item';
                goalEl.innerHTML = `
                    <div class="goal-header">
                        <h4>Meta ${idx + 1}</h4>
                        <button class="btn btn-danger btn-sm" onclick="removeGoal(${idx})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="goal-content">
                        <input type="text" placeholder="Nome da meta" value="${goal.name || ''}" 
                               onchange="updateGoal(${idx}, 'name', this.value)">
                        <textarea placeholder="Descrição da meta" 
                                  onchange="updateGoal(${idx}, 'description', this.value)">${goal.description || ''}</textarea>
                        <input type="number" placeholder="Peso (%)" min="0" max="100" value="${goal.weight || 0}" 
                               onchange="updateGoal(${idx}, 'weight', this.value)">
                    </div>
                    <div class="goal-criteria">
                        <h5>Critérios de Avaliação:</h5>
                        <div class="criteria-grid">
                            <div class="criteria-item">
                                <label>Rating 1:</label>
                                <textarea placeholder="Critério para rating 1" 
                                          onchange="updateGoal(${idx}, 'rating_1_criteria', this.value)">${goal.rating_1_criteria || ''}</textarea>
                            </div>
                            <div class="criteria-item">
                                <label>Rating 2:</label>
                                <textarea placeholder="Critério para rating 2" 
                                          onchange="updateGoal(${idx}, 'rating_2_criteria', this.value)">${goal.rating_2_criteria || ''}</textarea>
                            </div>
                            <div class="criteria-item">
                                <label>Rating 3:</label>
                                <textarea placeholder="Critério para rating 3" 
                                          onchange="updateGoal(${idx}, 'rating_3_criteria', this.value)">${goal.rating_3_criteria || ''}</textarea>
                            </div>
                            <div class="criteria-item">
                                <label>Rating 4:</label>
                                <textarea placeholder="Critério para rating 4" 
                                          onchange="updateGoal(${idx}, 'rating_4_criteria', this.value)">${goal.rating_4_criteria || ''}</textarea>
                            </div>
                            <div class="criteria-item">
                                <label>Rating 5:</label>
                                <textarea placeholder="Critério para rating 5" 
                                          onchange="updateGoal(${idx}, 'rating_5_criteria', this.value)">${goal.rating_5_criteria || ''}</textarea>
                            </div>
                        </div>
                    </div>
                    <div class="goal-rating">
                        <label>Avaliação:</label>
                        <select onchange="updateGoal(${idx}, 'rating', this.value)">
                            <option value="">Selecione...</option>
                            <option value="1" ${goal.rating == 1 ? 'selected' : ''}>1 - Excelente</option>
                            <option value="2" ${goal.rating == 2 ? 'selected' : ''}>2 - Superou</option>
                            <option value="3" ${goal.rating == 3 ? 'selected' : ''}>3 - Atendeu</option>
                            <option value="4" ${goal.rating == 4 ? 'selected' : ''}>4 - Não Atendeu</option>
                            <option value="5" ${goal.rating == 5 ? 'selected' : ''}>5 - Insuficiente</option>
                        </select>
                    </div>`;
                container.appendChild(goalEl);
            });
            
            updateGoalsWeight();
        }

        // Adicionar meta
        function addGoal() {
            if (!isWindowOpen) return;
            
            goals.push({
                name: '',
                description: '',
                weight: 0,
                rating_1_criteria: '',
                rating_2_criteria: '',
                rating_3_criteria: '',
                rating_4_criteria: '',
                rating_5_criteria: '',
                rating: null
            });
            renderGoals();
        }

        // Remover meta
        function removeGoal(index) {
            if (!isWindowOpen) return;
            
            goals.splice(index, 1);
            renderGoals();
        }

        // Atualizar meta
        function updateGoal(index, field, value) {
            if (!isWindowOpen) return;
            
            goals[index][field] = value;
            updateGoalsWeight();
            calculateFinalRating();
        }

        // Atualizar peso total das metas
        function updateGoalsWeight() {
            const total = goals.reduce((sum, goal) => sum + (Number(goal.weight) || 0), 0);
            document.getElementById('goals-total-weight').textContent = total;
        }


        
        // Salvar metas
        async function saveGoals() {
            if (!currentEmployee) {
                alert('Nenhum funcionário selecionado');
                return;
            }
        
            if (!isWindowOpen) {
                alert('A janela de avaliação está fechada. Alterações não são permitidas.');
                return;
            }
        
            // Validar metas
            if (goals.length < 3) {
                alert('É necessário definir pelo menos 3 metas.');
                return;
            }
        
            if (goals.length > 5) {
                alert('É permitido definir no máximo 5 metas.');
                return;
            }
        
            // Validar critérios
            for (let i = 0; i < goals.length; i++) {
                const goal = goals[i];
                if (!goal.name || !goal.description) {
                    alert(`Meta ${i + 1}: Nome e descrição são obrigatórios.`);
                    return;
                }
                if (!goal.rating_1_criteria || !goal.rating_2_criteria || !goal.rating_3_criteria || 
                    !goal.rating_4_criteria || !goal.rating_5_criteria) {
                    alert(`Meta ${i + 1}: Todos os critérios de avaliação são obrigatórios.`);
                    return;
                }
            }
        
            alert('Metas validadas! Use o botão "Salvar Avaliação" para salvar tudo junto.');
        }
        
        // Definir rating
        function setRating(criteriaId, rating) {
            if (!isWindowOpen) return;
            
            document.querySelectorAll(`[data-criteria="${criteriaId}"]`).forEach(btn => btn.classList.remove('selected'));
            const btn = document.querySelector(`[data-criteria="${criteriaId}"][data-rating="${rating}"]`);
            if (btn) btn.classList.add('selected');
            
            evaluationData[criteriaId] = rating;
            calculateFinalRating();
        }

        // Atualizar pesos das dimensões
        function updateDimensionWeights() {
            const wInst = Number(document.getElementById('weight-institucional').value) || 0;
            const wFunc = Number(document.getElementById('weight-funcional').value) || 0;
            const wInd = Number(document.getElementById('weight-individual').value) || 0;
            const wMet = Number(document.getElementById('weight-metas').value) || 0;

            const total = wInst + wFunc + wInd + wMet;
            document.getElementById('total-weight').textContent = total.toFixed(2);

            dimensionWeights = {
                'INSTITUCIONAL': wInst,
                'FUNCIONAL': wFunc,
                'INDIVIDUAL': wInd,
                'METAS': wMet
            };

            calculateFinalRating();
        }

        // Calcular rating final
        function calculateFinalRating() {
            // Calcular médias por dimensão
            const dimensions = ['INSTITUCIONAL', 'FUNCIONAL', 'INDIVIDUAL'];
            const averages = {};

            dimensions.forEach(dim => {
                const cards = document.querySelectorAll(`[data-dimension="${dim}"]`);
                let total = 0, count = 0;
                cards.forEach(card => {
                    const btn = card.querySelector('.rating-btn.selected');
                    if (btn) {
                        total += Number(btn.dataset.rating);
                        count++;
                    }
                });
                averages[dim] = count ? (total / count) : 0;
                document.getElementById(`avg-${dim.toLowerCase()}`).textContent = `Média: ${Math.round(averages[dim]) || '-'}`;
            });

            // Calcular média das metas
            const goalsWithRating = goals.filter(goal => goal.rating);
            averages['METAS'] = goalsWithRating.length ? 
                (goalsWithRating.reduce((sum, goal) => sum + Number(goal.rating), 0) / goalsWithRating.length) : 0;
            document.getElementById('avg-metas').textContent = `Média: ${Math.round(averages['METAS']) || '-'}`;

            // Calcular rating final ponderado
            const w = dimensionWeights;
            const final = (
                averages['INSTITUCIONAL'] * (w['INSTITUCIONAL']/100) +
                averages['FUNCIONAL'] * (w['FUNCIONAL']/100) +
                averages['INDIVIDUAL'] * (w['INDIVIDUAL']/100) +
                averages['METAS'] * (w['METAS']/100)
            );

            const finalRounded = Math.round(final || 0);
            document.getElementById('final-rating').textContent = finalRounded || '-';
        }

        // Salvar avaliação do gestor
        async function saveManagerEvaluation() {
            if (!currentEmployee) {
                alert('Nenhum funcionário selecionado');
                return;
            }
        
            if (!isWindowOpen) {
                alert('A janela de avaliação está fechada. Alterações não são permitidas.');
                return;
            }
        
            // Validar metas
            if (goals.length < 3) {
                alert('É necessário definir pelo menos 3 metas.');
                return;
            }
        
            if (goals.length > 5) {
                alert('É permitido definir no máximo 5 metas.');
                return;
            }
        
            // Validar critérios das metas
            for (let i = 0; i < goals.length; i++) {
                const goal = goals[i];
                if (!goal.name || !goal.description) {
                    alert(`Meta ${i + 1}: Nome e descrição são obrigatórios.`);
                    return;
                }
                if (!goal.rating_1_criteria || !goal.rating_2_criteria || !goal.rating_3_criteria || 
                    !goal.rating_4_criteria || !goal.rating_5_criteria) {
                    alert(`Meta ${i + 1}: Todos os critérios de avaliação são obrigatórios.`);
                    return;
                }
            }
        
            // Validar pesos das dimensões
            const total = Object.values(dimensionWeights).reduce((sum, weight) => sum + weight, 0);
            if (Math.abs(total - 100) > 0.01) {
                alert('Os pesos das DIMENSÕES devem totalizar 100%.');
                return;
            }
        
            const roundCode = document.getElementById('round-code').value;
            if (!roundCode || roundCode.trim() === '') {
                alert('ERRO: Código da rodada não definido. Contate o RH para definir a rodada ativa.');
                return;
            }
        
            // Verificar se é uma nova rodada
            const currentRoundCode = document.getElementById('round-code').value;
            const existingRoundCode = evaluationData.evaluation?.round_code;
            
            if (existingRoundCode && existingRoundCode !== currentRoundCode) {
                const confirm = window.confirm(
                    `Você está alterando o código da rodada de "${existingRoundCode}" para "${currentRoundCode}".\n\n` +
                    `Isso criará uma NOVA avaliação mantendo a anterior no histórico.\n\n` +
                    `Deseja continuar?`
                );
                
                if (!confirm) {
                    return;
                }
            }
        
            // Construir payload
            const payload = {
                employee_id: currentEmployee.id,
                evaluator_id: 1, // ID do gestor (pode ser dinâmico)
                evaluation_year: 2025,
                round_code: roundCode,
                responses: evaluationData,
                goals: goals,
                goals_average: calculateGoalsAverage(),
                dimension_weights: dimensionWeights,
                dimension_averages: {
                    INSTITUCIONAL: calculateDimensionAverage('INSTITUCIONAL'),
                    FUNCIONAL: calculateDimensionAverage('FUNCIONAL'),
                    INDIVIDUAL: calculateDimensionAverage('INDIVIDUAL'),
                    METAS: calculateGoalsAverage()
                },
                final_rating: Number(document.getElementById('final-rating').textContent) || 0
            };
        
            try {
                const response = await fetch('/api/evaluations', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
        
                if (!response.ok) {
                    const error = await response.json();
                    alert('Erro ao salvar: ' + (error.error || 'Erro desconhecido'));
                    return;
                }
        
                alert('Avaliação salva com sucesso!');
                
            } catch (e) {
                console.error('Erro ao salvar:', e);
                alert('Erro ao salvar avaliação');
            }
        }

        
        // Calcular média de uma dimensão
        function calculateDimensionAverage(dimension) {
            const cards = document.querySelectorAll(`[data-dimension="${dimension}"]`);
            let total = 0, count = 0;
            cards.forEach(card => {
                const btn = card.querySelector('.rating-btn.selected');
                if (btn) {
                    total += Number(btn.dataset.rating);
                    count++;
                }
            });
            return count ? (total / count) : 0;
        }

        // Calcular média das metas
        function calculateGoalsAverage() {
            const goalsWithRating = goals.filter(goal => goal.rating);
            return goalsWithRating.length ? 
                (goalsWithRating.reduce((sum, goal) => sum + Number(goal.rating), 0) / goalsWithRating.length) : 0;
        }

        // Ver posição 9-box
        function viewNineBoxPosition() {
            if (!currentEmployee) {
                alert('Selecione um funcionário primeiro');
                return;
            }
            
            // Redirecionar para a página principal com a matriz 9-box
            window.open('/', '_blank');
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            loadTeamMembers();
            loadWindowStatus();
            
            // Event listeners para pesos
            ['weight-institucional', 'weight-funcional', 'weight-individual', 'weight-metas'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateDimensionWeights);
                document.getElementById(id).addEventListener('change', updateDimensionWeights);
            });
            lockDWInputs();
        });
    </script>
</body>
</html>
