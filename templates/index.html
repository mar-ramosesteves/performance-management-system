<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gest√£o de Desempenho</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 60px 0;
        }
        .feature-card {
            transition: transform 0.3s ease;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .feature-card:hover { transform: translateY(-5px); }
        .icon-large { font-size: 3rem; color: #667eea; }
        .employee-card {
            border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 20px;
            background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .employee-card:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .evaluation-section {
            background: #f8f9fa; padding: 30px; border-radius: 10px; margin: 20px 0;
        }
        .criteria-card {
            background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 15px;
        }
        .rating-buttons { display: flex; gap: 10px; margin-top: 10px; }
        .rating-btn {
            width: 40px; height: 40px; border: 2px solid #ddd; border-radius: 50%;
            background: white; color: #666; font-weight: bold; transition: all 0.3s ease;
        }
        .rating-btn:hover { border-color: #667eea; color: #667eea; }
        .rating-btn.selected { background: #667eea; border-color: #667eea; color: white; }
        .dimension-header { background: #667eea; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .type-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .type-desempenho { background: #28a745; color: white; }
        .type-potencial  { background: #17a2b8; color: white; }
        .goals-section   { background: #e8f4fd; border: 2px solid #17a2b8; border-radius: 10px; padding: 20px; margin: 20px 0; }
        .goal-card { background: white; border: 1px solid #17a2b8; border-radius: 8px; padding: 20px; margin-bottom: 15px; }
        .weight-input { width: 80px; text-align: center; }
        .total-weight {
            background: #28a745; color: white; padding: 10px; border-radius: 5px; text-align: center; font-weight: bold;
        }
        .total-weight.invalid { background: #dc3545; }
        .dimension-weights { background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 20px; margin: 20px 0; }
        .final-rating { background: #d4edda; border: 2px solid #28a745; border-radius: 10px; padding: 20px; margin: 20px 0; text-align: center; }
        .final-rating-value { font-size: 2rem; font-weight: bold; color: #28a745; }

        /* Matriz 9-Box (cards iniciais do topo) */
        .nine-box-container {
            display: grid; grid-template-columns: 100px 120px 120px 120px; grid-template-rows: 40px 80px 80px 80px;
            gap: 5px; margin: 20px auto; max-width: 500px;
        }
        .performance-header, .potential-header {
            display: flex; align-items: center; justify-content: center; font-weight: bold;
            background-color: #f0f0f0; border: 1px solid #ccc; padding: 5px;
        }
        .potential-header { writing-mode: vertical-rl; text-orientation: mixed; }
        .nine-box-cell {
            border: 2px solid #333; display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 5px; min-height: 80px; max-height: 80px; overflow: hidden;
        }
        .nine-box-cell.occupied { background-color: rgba(255, 255, 255, 0.9); }
        .employee-name { font-weight: bold; font-size: 12px; text-align: center; margin-bottom: 2px; }
        .employee-rating { font-size: 10px; color: #666; text-align: center; }
        .box-title { font-size: 10px; color: #999; text-align: center; }
        .box-1 { background-color: #90EE90; }
        .box-2 { background-color: #ADD8E6; }
        .box-3 { background-color: #FFC0CB; }
        .box-4 { background-color: #90EE90; }
        .box-5 { background-color: #FFFFE0; }
        .box-6 { background-color: #FFDAB9; }
        .box-7 { background-color: #FFA500; }
        .box-8 { background-color: #FFDAB9; }
        .box-9 { background-color: #FF0000; }
        .matrix-labels {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 2px; margin-bottom: 10px; max-width: 600px;
            margin-left: auto; margin-right: auto;
        }
        .matrix-label { text-align: center; font-weight: bold; padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; }
        .matrix-y-labels {
            display: flex; flex-direction: column; justify-content: space-between; height: 360px; margin-right: 10px; max-width: 600px;
            margin-left: auto; margin-right: auto;
        }
        .matrix-y-label { text-align: center; font-weight: bold; padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; writing-mode: vertical-rl; text-orientation: mixed; }

        /* M√©dias das dimens√µes */
        .dimension-average {
            background-color: #e3f2fd; color: #1565c0; padding: 4px 8px; border-radius: 4px; font-weight: bold; margin-left: 10px; font-size: 12px;
        }
        .weight-item { display: flex; align-items: center; margin-bottom: 10px; gap: 10px; }
        .weight-item label { min-width: 100px; font-weight: bold; }

        /* Metas */
        .goal-item {
            border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 20px; background-color: #f9f9f9;
        }
        .goal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .goal-header h4 { margin: 0; color: #2c3e50; }
        .goal-content { margin-bottom: 15px; }
        .goal-content input, .goal-content textarea {
            width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;
        }
        .goal-criteria { margin-bottom: 15px; }
        .goal-criteria h5 { margin-bottom: 10px; color: #34495e; }
        .criteria-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
        .criteria-item { display: flex; flex-direction: column; }
        .criteria-item label { font-weight: bold; margin-bottom: 5px; color: #2c3e50; }
        .criteria-item textarea { padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; min-height: 60px; }
        .goal-rating { display: flex; align-items: center; gap: 10px; }
        .goal-rating label { font-weight: bold; color: #2c3e50; }
        .goal-rating select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-width: 200px; }
    </style>
</head>

<script>
/* ============================================================
   BOOTSTRAP DO MODO DE LINK DIRETO (?employee_id=...&open=...)
   - Com open=latest: NUNCA abre avalia√ß√£o em branco
   - Espera a fun√ß√£o real viewEmployeeEvaluation e chama s√≥ ela
   - Se ela n√£o carregar a tempo, usa fallback que l√™ /api/evaluations/latest
   ============================================================ */

(function () {
  const params  = new URLSearchParams(window.location.search);
  const empId   = params.get('employee_id');         // ex.: 149
  const manager = params.get('manager_name') || params.get('manager');
  const open    = (params.get('open') || '').toLowerCase();  // "latest", "new", etc.
  const mode    = (params.get('mode') || '').toLowerCase();  // "edit" (opcional)

  // Util: espera at√© N tentativas a fun√ß√£o global existir
  function waitFor(fnName, cb, tries=30) {
    if (typeof window[fnName] === 'function') return cb(null, window[fnName]);
    if (tries <= 0) return cb(new Error('timeout'));
    setTimeout(() => waitFor(fnName, cb, tries - 1), 200);
  }

  // Fallback: carrega a √öLTIMA avalia√ß√£o direto do backend e preenche a tela
  async function fallbackLoadLatest(id) {
    try {
      const qs = new URLSearchParams();
    
      qs.set("employee_id", String(id));
    
      // se a URL tiver ?round_code=YE2025, a gente manda junto
      const rc = new URLSearchParams(window.location.search).get("round_code");
      if (rc) qs.set("round_code", rc);
    
      const r = await fetch(`/api/evaluations/latest?${qs.toString()}`);
        
      if (!r.ok) throw new Error('latest not found');
      const payload = await r.json();
      const { evaluation: ev } = payload;

      // Garante que a UI de crit√©rios exista antes de popular
      if (typeof window.loadEvaluationCriteria === 'function') {
        await window.loadEvaluationCriteria();
      }

      // Usa o populador existente da sua p√°gina (preenche pesos, metas, respostas)
      if (typeof window.populateExistingEvaluation === 'function') {
        await window.populateExistingEvaluation(ev);
      } else if (typeof window.viewEmployeeEvaluation === 'function') {
        // Se a fun√ß√£o real aparecer, chama ela
        return window.viewEmployeeEvaluation(Number(id));
      }

      // Mostra a se√ß√£o
      const sec = document.getElementById('evaluation-section');
      if (sec) {
        sec.style.display = 'block';
        sec.scrollIntoView({ behavior: 'smooth' });
      }
    } catch (e) {
      console.warn('[fallbackLoadLatest] falhou, abrindo formul√°rio vazio como √∫ltimo recurso.', e);
      if (typeof window.startEvaluationForEmployee === 'function') {
        window.startEvaluationForEmployee(Number(id));
      }
    }
  }

  // 1) Se veio manager_name, tenta listar o time do gestor (se a p√°gina tiver isso)
  if (manager && typeof window.loadEmployeesByManager === 'function') {
    try { window.loadEmployeesByManager(manager); } catch {}
  }

  // 2) Se veio employee_id, decide o que abrir
  if (empId) {
    // Caso expl√≠cito: open=latest -> sempre abrir a √öLTIMA avalia√ß√£o (N√ÉO abre formul√°rio novo)
    if (open === 'latest') {
      waitFor('viewEmployeeEvaluation', (err) => {
        if (!err) {
          try { window.viewEmployeeEvaluation(Number(empId)); }
          catch { fallbackLoadLatest(Number(empId)); }
        } else {
          // Se a fun√ß√£o ainda n√£o carregou, usa fallback direto no endpoint
          fallbackLoadLatest(Number(empId));
        }
      });
      return; // Evita qualquer chamada ao formul√°rio novo
    }

    // Outros casos: se quiser ‚Äúnovo‚Äù, chame explicitamente com open=new
    if (open === 'new') {
      waitFor('startEvaluationForEmployee', (err) => {
        if (!err) window.startEvaluationForEmployee(Number(empId));
        else fallbackLoadLatest(Number(empId)); // se n√£o carregou, pelo menos mostra a √∫ltima
      });
      return;
    }

    // Sem 'open' definido: padr√£o amig√°vel = tentar √∫ltima; se n√£o houver, abre novo
    waitFor('viewEmployeeEvaluation', (err) => {
      if (!err) {
        try { window.viewEmployeeEvaluation(Number(empId)); }
        catch { fallbackLoadLatest(Number(empId)); }
      } else {
        fallbackLoadLatest(Number(empId));
      }
    });
  }
})();
</script>


    
    
<body>
    <!-- Hero Section -->
    <section class="hero-section">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 mx-auto text-center">
                    <h1 class="display-4 fw-bold mb-4">Sistema de Gest√£o de Desempenho</h1>
                    <p class="lead mb-4">Plataforma completa para avalia√ß√£o de performance, matriz 9-box e gest√£o de talentos</p>
                    <div class="d-flex gap-3 justify-content-center">
                        <button class="btn btn-light btn-lg px-4" onclick="loadEmployees()">
                            <i class="fas fa-users me-2"></i>Ver Funcion√°rios
                        </button>
                        <button class="btn btn-outline-light btn-lg px-4" onclick="startEvaluation()">
                            <i class="fas fa-clipboard-check me-2"></i>Nova Avalia√ß√£o
                        </button>
                        <button class="btn btn-outline-light btn-lg px-4" onclick="showNineBoxMatrix()">
                            <i class="fas fa-th me-2"></i>Matriz 9-Box
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Features Section -->
    <section class="py-5">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 mb-4">
                    <div class="card feature-card h-100 text-center p-4">
                        <div class="card-body">
                            <i class="fas fa-chart-line icon-large mb-3"></i>
                            <h5 class="card-title">Matriz 9-Box</h5>
                            <p class="card-text">Avalia√ß√£o completa de performance e potencial com visualiza√ß√£o interativa</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 mb-4">
                    <div class="card feature-card h-100 text-center p-4">
                        <div class="card-body">
                            <i class="fas fa-users icon-large mb-3"></i>
                            <h5 class="card-title">Gest√£o de Talentos</h5>
                            <p class="card-text">Organograma moderno e gest√£o completa do capital humano</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 mb-4">
                    <div class="card feature-card h-100 text-center p-4">
                        <div class="card-body">
                            <i class="fas fa-database icon-large mb-3"></i>
                            <h5 class="card-title">Reposit√≥rio Central</h5>
                            <p class="card-text">Integra√ß√£o com sistemas de folha e auditoria completa</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Employees Section -->
    <section class="py-5 bg-light" id="employees-section" style="display: none;">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <h2 class="text-center mb-5">Profissionais Cadastrados</h2>
                    <div id="employees-container" class="row"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Matriz 9-Box Corrigida -->
    <section id="nine-box-section" style="display: none;">
        <h2>üìä Matriz 9-Box</h2>
        <style>
            #nine-box-section h2 {
                text-align: center; font-size: 28px; font-weight: bold; color: #2c3e50; margin: 30px 0;
                text-shadow: 2px 2px 4px rgba(0,0,0,0.1); letter-spacing: 1px;
            }
            .nine-box-table { border-collapse: collapse; margin: 20px auto; font-family: Arial, sans-serif; display: table; width: auto; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
            .nine-box-table tr { display: table-row; }
            .nine-box-table td { width: 200px; height: 120px; border: 2px solid #333; text-align: center; vertical-align: middle; padding: 10px; font-size: 11px; line-height: 1.3; overflow: hidden; display: table-cell; }
            .header-cell { background: #e3f2fd; color: #1565c0; font-weight: 900; font-size: 18px; vertical-align: middle; display: table-cell; padding: 15px 8px; text-shadow: 1px 1px 2px rgba(0,0,0,0.0); letter-spacing: 0.5px; text-transform: uppercase; }
            .header-cell:first-child { width: 120px; }
            .nine-box-table tr td:first-child { width: 120px; }
            .box-1 { background-color: #90EE90; } .box-2 { background-color: #87CEEB; } .box-3 { background-color: #FFB6C1; }
            .box-4 { background-color: #98FB98; } .box-5 { background-color: #FFFFE0; } .box-6 { background-color: #FFE4B5; }
            .box-7 { background-color: #FFA500; } .box-8 { background-color: #FFA07A; } .box-9 { background-color: #FF6B6B; }
            .nine-box-cell:hover { transform: scale(1.02); transition: transform 0.2s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        </style>
        <table class="nine-box-table">
            <tr>
                <td class="header-cell"></td>
                <td class="header-cell">Alto Desempenho</td>
                <td class="header-cell">M√©dio Desempenho</td>
                <td class="header-cell">Baixo Desempenho</td>
            </tr>
            <tr>
                <td class="header-cell">Alto Potencial</td>
                <td class="nine-box-cell box-1" data-position="1"></td>
                <td class="nine-box-cell box-2" data-position="2"></td>
                <td class="nine-box-cell box-3" data-position="3"></td>
            </tr>
            <tr>
                <td class="header-cell">M√©dio Potencial</td>
                <td class="nine-box-cell box-4" data-position="4"></td>
                <td class="nine-box-cell box-5" data-position="5"></td>
                <td class="nine-box-cell box-6" data-position="6"></td>
            </tr>
            <tr>
                <td class="header-cell">Baixo Potencial</td>
                <td class="nine-box-cell box-7" data-position="7"></td>
                <td class="nine-box-cell box-8" data-position="8"></td>
                <td class="nine-box-cell box-9" data-position="9"></td>
            </tr>
        </table>
    </section>

    <!-- Evaluation Section -->
    <section class="py-5" id="evaluation-section" style="display: none;">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <h2 class="text-center mb-5">Avalia√ß√£o de Desempenho 2025</h2>

                    <!-- C√≥digo da Rodada -->
                    <div class="evaluation-section" style="background: #e8f4fd; border: 2px solid #17a2b8; border-radius: 10px; padding: 20px; margin: 20px 0;">
                        <h4><i class="fas fa-calendar-alt me-2"></i>C√≥digo da Rodada</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="round-code" class="form-label"><strong>C√≥digo da Rodada:</strong></label>
                                <input type="text" id="round-code" class="form-control" placeholder="Ex: Start2025, IR2025, YE2025"
                                       pattern="^(Start|IR|YE)\d{4}$" title="Formato: Start2025, IR2025, YE2025" readonly>
                                <div class="form-text">
                                    <small class="text-muted">
                                        <strong>Formatos v√°lidos:</strong><br>
                                        ‚Ä¢ Start2025 - Defini√ß√£o de Metas (EMPENHO)<br>
                                        ‚Ä¢ IR2025 - Interim Review (Estimativa)<br>
                                        ‚Ä¢ YE2025 - Year End Review (Final)
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Employee Info (cabe√ßalho completo) -->
                    <div class="evaluation-section" id="employee-header">
                        <h4>Informa√ß√µes do Avaliado</h4>
                        <style>
                            .emp-grid{ display:grid; gap:10px; grid-template-columns: repeat(6, 1fr); }
                            @media (max-width: 992px){ .emp-grid{grid-template-columns: repeat(2, 1fr);} }
                            .emp-cell{ background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:10px }
                            .emp-label{ font-size:12px; color:#6b7280; margin-bottom:4px }
                            .emp-value{ font-weight:700; color:#111; word-break:break-word }
                            .emp-title{ grid-column: 1 / -1; text-align:center; font-size:18px; font-weight:800; padding:8px 0 }
                        </style>

                        <div class="emp-grid">
                            <div class="emp-cell emp-title" id="emp-title">-</div>
                            <div class="emp-cell"><div class="emp-label">ID</div><div class="emp-value" id="employee-id">-</div></div>
                            <div class="emp-cell"><div class="emp-label">Nome</div><div class="emp-value" id="employee-name">-</div></div>
                            <div class="emp-cell"><div class="emp-label">Cargo</div><div class="emp-value" id="employee-role">-</div></div>
                            <div class="emp-cell"><div class="emp-label">Departamento</div><div class="emp-value" id="employee-dept">-</div></div>
                            <div class="emp-cell"><div class="emp-label">Empresa</div><div class="emp-value" id="employee-company">-</div></div>
                            <div class="emp-cell"><div class="emp-label">Filial</div><div class="emp-value" id="employee-branch">-</div></div>
                            <div class="emp-cell"><div class="emp-label">Data admiss√£o</div><div class="emp-value" id="employee-admission">-</div></div>
                            <div class="emp-cell"><div class="emp-label">Gestor imediato</div><div class="emp-value" id="employee-manager">-</div></div>
                            <div class="emp-cell"><div class="emp-label">Data nascimento</div><div class="emp-value" id="employee-birth">-</div></div>
                            <div class="emp-cell"><div class="emp-label">Situa√ß√£o</div><div class="emp-value" id="employee-status">-</div></div>
                            <div class="emp-cell"><div class="emp-label">Motivo afastamento</div><div class="emp-value" id="employee-leave-reason">-</div></div>
                            <div class="emp-cell"><div class="emp-label">Sal√°rio base</div><div class="emp-value" id="employee-salary">-</div></div>
                            <div class="emp-cell"><div class="emp-label">% HAY (MED)</div><div class="emp-value" id="employee-hay">-</div></div>
                            <div class="emp-cell"><div class="emp-label">Rating 2025</div><div class="emp-value" id="employee-rating">-</div></div>
                        </div>
                    </div>

                    <!-- Dimension Weights -->
                    <div class="dimension-weights">
                        <h3>Dimension Weights</h3>
                        <div class="weight-inputs">
                            <div class="weight-item">
                                <label>INSTITUCIONAL:</label>
                                <input type="number" id="weight-institucional" min="0" max="100" value="">
                                <span>%</span>
                                <span class="dimension-average" id="avg-institucional">-</span>
                            </div>
                            <div class="weight-item">
                                <label>FUNCIONAL:</label>
                                <input type="number" id="weight-funcional" min="0" max="100" value="">
                                <span>%</span>
                                <span class="dimension-average" id="avg-funcional">-</span>
                            </div>
                            <div class="weight-item">
                                <label>INDIVIDUAL:</label>
                                <input type="number" id="weight-individual" min="0" max="100" value="">
                                <span>%</span>
                                <span class="dimension-average" id="avg-individual">-</span>
                            </div>
                            <div class="weight-item">
                                <label>METAS:</label>
                                <input type="number" id="weight-metas" min="0" max="100" value="">
                                <span>%</span>
                                <span class="dimension-average" id="avg-metas">-</span>
                            </div>
                        </div>
                        <div class="total-weight">
                            <strong>Total: <span id="total-weight">0</span>%</strong>
                        </div>
                    </div>

                    <!-- Evaluation Criteria -->
                    <div id="evaluation-criteria"></div>

                    <!-- Goals Section -->
                    <div class="goals-section">
                        <h4><i class="fas fa-bullseye me-2"></i>Metas Individuais (3 a 5 metas)</h4>
                        <div id="goals-container"></div>

                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div class="d-flex gap-2">
                                <button class="btn btn-success btn-sm" onclick="addGoal()">
                                    <i class="fas fa-plus me-1"></i>Adicionar Meta
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="saveGoals()">
                                    <i class="fas fa-save me-1"></i>Salvar Metas
                                </button>
                            </div>
                            <div class="total-weight" id="total-goals-weight">Total: 0%</div>
                        </div>
                    </div>

                    <!-- Final Rating -->
                    <div class="final-rating">
                        <h4>Rating Final</h4>
                        <div class="final-rating-value" id="final-rating">-</div>
                        <p class="mt-2">1 = Excelente | 2 = Superou | 3 = Atendeu | 4 = N√£o Atendeu | 5 = Insuficiente</p>
                    </div>

                    <!-- Submit Button -->
                    <div class="text-center mt-4">
                        <button id="btnSalvarAvaliacao" class="btn btn-success btn-lg" onclick="submitEvaluation()">
                            <i class="fas fa-save me-2"></i>Salvar Avalia√ß√£o
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // ===== Utils b√°sicos =====
    function qs(sel, el=document){ return el.querySelector(sel); }
    function qsa(sel, el=document){ return [...el.querySelectorAll(sel)]; }
    function toNumber(v, d=0){ const n = parseFloat(v); return isNaN(n) ? d : n; }
    function round(n){ return Math.round(n); }

    // --- Util para ler par√¢metros da URL e definir MANAGER_NAME (√∫nica defini√ß√£o) ---
    function getParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }
    const MANAGER_NAME = (getParam('manager_name') || getParam('manager') || '')
      .replace(/^"+|"+$/g, '')
      .trim();

    // ===== Helpers de formata√ß√£o (√∫nicos) =====
    window.moneyBR = window.moneyBR || function(v){
      if (v==null || v==='') return '-';
      const n = Number(v);
      if (Number.isNaN(n)) return String(v);
      return n.toLocaleString('pt-BR', { style:'currency', currency:'BRL' });
    };
    window.dateBR = window.dateBR || function(v){
      if (!v) return '-';
      const d = new Date(v);
      if (Number.isNaN(d.valueOf())) return v;
      return d.toLocaleDateString('pt-BR');
    };

    function fmtEmpCode(emp){
      const code = (emp?.employee_code ?? '').toString().trim();
      if (code) return code.padStart(4,'0');
      return (emp?.id != null) ? `INT-${emp.id}` : '-';
    }

    // ===== Estado =====
    let currentEmployee = null;
    let evaluationData = {};
    let dimensionWeights = { INSTITUCIONAL: 15, FUNCIONAL: 15, INDIVIDUAL: 30, METAS: 40 };
    let currentEvaluationId = null; // id da avalia√ß√£o que est√° aberta (para edi√ß√£o)



    

    // ===== Normalizadores =====
    function normalizeDimensionWeights(w) {
      const out = { INSTITUCIONAL: 0, FUNCIONAL: 0, INDIVIDUAL: 0, METAS: 0 };
      if (!w || typeof w !== 'object') return out;
      const src = (w.dimension_weights && typeof w.dimension_weights === 'object') ? w.dimension_weights : w;
      for (const [k, v] of Object.entries(src)) {
        const key = String(k).toUpperCase().trim();
        const num = Number(v);
        if (!Number.isNaN(num)) {
          if (key === 'INSTITUCIONAL') out.INSTITUCIONAL = num;
          if (key === 'FUNCIONAL')     out.FUNCIONAL     = num;
          if (key === 'INDIVIDUAL')    out.INDIVIDUAL    = num;
          if (key === 'METAS')         out.METAS         = num;
        }
      }
      return out;
    }

    // ===== Cabe√ßalho do avaliado =====
    function setEmployeeHeader(emp, lastFinalRating = null){
      const get = (v, alt='-') => (v==null || v==='') ? alt : v;
      const titleEl = document.getElementById('emp-title');
      if (titleEl) titleEl.textContent = get(emp?.nome, '-').toUpperCase();
      const map = {
        'employee-id':        emp?.id,
        'employee-name':      emp?.nome,
        'employee-role':      emp?.cargo,
        'employee-dept':      emp?.department_name,
        'employee-company':   emp?.empresa || emp?.company_name,
        'employee-branch':    emp?.branch_name,
        'employee-admission': dateBR(emp?.admission_date),
        'employee-manager':   emp?.manager_name,
        'employee-birth':     dateBR(emp?.birth_date),
        'employee-status':    emp?.employment_status || 'ATIVO',
        'employee-leave-reason': emp?.leave_reason,
        'employee-salary':    moneyBR(emp?.salario),
        'employee-hay':       emp?.hay_percent ?? '‚Äî',
        'employee-rating':    (lastFinalRating != null) ? lastFinalRating : '-'
      };
      Object.entries(map).forEach(([id, val])=>{
        const el = document.getElementById(id);
        if (el) el.textContent = (val===undefined || val===null || val==='') ? '-' : val;
      });
    }

    /* ========================= Funcion√°rios ========================= */
    async function loadEmployees() {
      if (MANAGER_NAME) {
        const sec = document.getElementById('employees-section');
        if (sec) sec.style.display = 'block';
        try {
          const resp = await fetch('/api/employees/by-manager?manager_name=' + encodeURIComponent(MANAGER_NAME));
          const employees = await resp.json();
          const container = document.getElementById('employees-container');
          if (!container) return;
          container.innerHTML = '';
          if (!Array.isArray(employees) || employees.length === 0) {
            container.innerHTML = `<div class="col-12"><div class="alert alert-warning">N√£o h√° colaboradores para o gestor <strong>${MANAGER_NAME}</strong>.</div></div>`;
            return;
          }
          employees.forEach(emp => {
            const col = document.createElement('div');
            col.className = 'col-md-4';
            col.innerHTML = `
              <div class="employee-card">
                <h5 class="mb-1">${emp.nome || '-'}</h5>
                <div class="text-muted mb-2">${emp.cargo || '-'}</div>
                <div><small>Empresa:</small> ${emp.empresa || emp.company_name || '-'}</div>
                <div><small>Depto.:</small> ${emp.department_name || '-'}</div>
                <div class="mt-3 d-flex gap-2">
                  <button class="btn btn-sm btn-primary" onclick="startEvaluationForEmployee(${emp.id})">
                    <i class="fas fa-clipboard-check me-1"></i>Avaliar
                  </button>
                  <button class="btn btn-sm btn-outline-secondary" onclick="viewEmployeeEvaluation(${emp.id})">
                    <i class="fas fa-eye me-1"></i>Ver Avalia√ß√£o
                  </button>

                  </button>

                  </button>
                </div>
              </div>`;
            container.appendChild(col);
          });
          const heroBtn = document.querySelector('button[onclick="loadEmployees()"]');
          if (heroBtn) heroBtn.textContent = 'Meu Time';
        } catch (e) {
          console.error(e);
          alert('Erro ao carregar a lista do gestor.');
        }
        return;
      }

      try {
        const response = await fetch('/api/employees');
        const employees = await response.json();
        const sec = document.getElementById('employees-section');
        if (sec) sec.style.display = 'block';
        const container = document.getElementById('employees-container');
        if (!container) return;
        container.innerHTML = '';
        employees.forEach(emp => {
          const col = document.createElement('div');
          col.className = 'col-md-4';
          col.innerHTML = `
            <div class="employee-card">
              <h5 class="mb-1">${emp.nome || '-'}</h5>
              <div class="text-muted mb-2">${emp.cargo || '-'}</div>
              <div><small>Empresa:</small> ${emp.empresa || emp.company_name || '-'}</div>
              <div><small>Depto.:</small> ${emp.department_name || '-'}</div>
              <div class="mt-3 d-flex gap-2">
                <button class="btn btn-sm btn-primary" onclick="startEvaluationForEmployee(${emp.id})">
                  <i class="fas fa-clipboard-check me-1"></i>Avaliar
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="viewEmployeeEvaluation(${emp.id})">
                  <i class="fas fa-eye me-1"></i>Ver Avalia√ß√£o
                </button>

                </button>

                </button>
              </div>
            </div>`;
          container.appendChild(col);
        });
      } catch (error) {
        console.error('Erro ao carregar funcion√°rios:', error);
      }
    }

    function renderEmployeeCard(emp) {
      const col = document.createElement('div');
      col.className = 'col-md-6 col-lg-4';
      const nome = emp?.nome || 'Sem nome';
      const cargo = emp?.cargo || '‚Äî';
      const empresa = emp?.empresa || emp?.company_name || '‚Äî';
      const depto = emp?.department_name || '‚Äî';
      const filial = emp?.branch_name || '‚Äî';
      const gestor = emp?.manager_name || '‚Äî';
      const salario = (typeof window.moneyBR === 'function') ? moneyBR(emp?.salario) : (emp?.salario ?? '‚Äî');
      const empCode = (typeof fmtEmpCode === 'function') ? fmtEmpCode(emp) : (emp?.id ?? '‚Äî');
      col.innerHTML = `
        <div class="employee-card h-100 d-flex flex-column">
          <div class="d-flex align-items-start justify-content-between mb-2">
            <h5 class="mb-0">${nome}</h5>
            <span class="badge bg-secondary">ID: ${empCode}</span>
          </div>
          <div class="text-muted small mb-3">
            <div><strong>Cargo:</strong> ${cargo}</div>
            <div><strong>Empresa:</strong> ${empresa}</div>
            <div><strong>Departamento:</strong> ${depto}</div>
            <div><strong>Filial:</strong> ${filial}</div>
            <div><strong>Gestor:</strong> ${gestor}</div>
            <div><strong>Sal√°rio:</strong> ${salario}</div>
          </div>
          <div class="mt-auto d-flex gap-2">
            <button class="btn btn-primary btn-sm flex-fill" onclick="startEvaluationForEmployee(${emp.id})">
              <i class="fas fa-clipboard-check me-1"></i> Nova Avalia√ß√£o
            </button>
            <button class="btn btn-outline-secondary btn-sm flex-fill" onclick="viewEmployeeEvaluation(${emp.id})">
              <i class="fas fa-eye me-1"></i> Ver Avalia√ß√£o
            </button>
          </div>
        </div>
      `;
      return col;
    }

    function startEvaluation() { alert('Selecione um funcion√°rio para avaliar'); }
    function editEmployee(id) { alert(`Editar funcion√°rio ID: ${id} (em desenvolvimento)`); }

    /* ========================= NINE-BOX ========================= */
    async function showNineBoxMatrix() {
      try {
        const respEval = await fetch('/api/evaluations');
        const evaluations = await respEval.json();
        const respEmp = await fetch('/api/employees');
        const employees = await respEmp.json();

        qsa('.nine-box-cell').forEach(c => c.innerHTML = '');
        const byPos = {1:[],2:[],3:[],4:[],5:[],6:[],7:[],8:[],9:[]};

        evaluations.forEach(ev => {
          const emp = employees.find(e => e.id === ev.employee_id);
          if (!emp) return;
          if (!ev.performance_rating || !ev.potential_rating) return;
          const potencial = Math.round(ev.potential_rating);
          const desempenho = Math.round(ev.performance_rating);
          let linha = (potencial >= 7) ? 1 : (potencial >= 4) ? 2 : 3;
          let coluna = (desempenho >= 7) ? 1 : (desempenho >= 4) ? 2 : 3;
          const pos = (linha - 1) * 3 + coluna;
          if (pos >= 1 && pos <= 9) byPos[pos].push(emp.nome);
        });

        for (let i=1;i<=9;i++){
          const cell = qs(`[data-position="${i}"]`);
          if (cell && byPos[i].length) cell.textContent = byPos[i].join(', ');
        }
        qs('#nine-box-section').style.display = 'block';
      } catch (e) {
        console.error(e);
        alert('Erro ao carregar matriz 9-box');
      }
    }

    /* ========================= Avalia√ß√£o ========================= */
    async function startEvaluationForEmployee(employeeId) {
      try {
        const resp = await fetch('/api/employees');
        const employees = await resp.json();
        const foundEmployee = employees.find(emp => Number(emp.id) === Number(employeeId));
        if (!foundEmployee) {
          alert('Funcion√°rio n√£o encontrado');
          return;
        }
        
        // ‚úÖ CORRE√á√ÉO CR√çTICA: Sempre definir o funcion√°rio correto
        currentEmployee = foundEmployee;
        window.currentEmployee = foundEmployee;
        
        // ‚úÖ Limpar TUDO
        window.currentEvaluationId = null;
        window.lastLoadedEvaluationId = null;
        currentEvaluationId = null;
        window.evaluationData = {};
        evaluationData = {};
        
        console.log('[startEvaluationForEmployee] ‚úÖ Funcion√°rio:', foundEmployee.id, foundEmployee.nome);

          
        let lastFinalRating = null;
        try {
          const r = await fetch(`/api/evaluations/latest?employee_id=${employeeId}`);
          if (r.ok) {
            const j = await r.json();
            lastFinalRating = (j?.evaluation?.final_rating ?? null);
          }
        } catch (_) {}

        setEmployeeHeader(currentEmployee, lastFinalRating);
        const idEl = document.querySelector('#employee-id');
        if (idEl) idEl.textContent = fmtEmpCode(currentEmployee);

        await loadEvaluationCriteria();
        await loadActiveRoundCode();
        await loadCentralDimensionWeights();

        // ‚úÖ Bloquear campos se for gestor
        lockDimensionWeightsForManager();
          
        evaluationData = {};
        const goalsContainer = document.querySelector('#goals-container');
        if (goalsContainer) goalsContainer.innerHTML = '';
        evaluationData = {};
        await loadGoals();

        initDimensionWeights();
        calculateFinalRating();

        document.getElementById('evaluation-section').style.display = 'block';
        document.getElementById('evaluation-section').scrollIntoView({behavior:'smooth'});
      } catch (e) {
        console.error(e);
        alert('Erro ao iniciar avalia√ß√£o');
      }
    }

    async function loadEvaluationCriteria() {
      try {
        const response = await fetch('/api/evaluation-criteria');
        const criteria = await response.json();
        const container = qs('#evaluation-criteria');
        container.innerHTML = '';
        const dimensions = {};
        criteria.forEach(c => {
          const dim = (c.dimension || '').toUpperCase();
          if (!dimensions[dim]) dimensions[dim] = [];
          dimensions[dim].push(c);
        });
        Object.keys(dimensions).forEach(dimension => {
          const section = document.createElement('div');
          section.className = 'evaluation-section';
          let html = `
            <div class="dimension-header">
              <h4>DIMENS√ÉO ${dimension}</h4>
            </div>`;
          dimensions[dimension].forEach(c => {
            const typeClass = `type-${(c.type||'').toLowerCase()}`;
            html += `
              <div class="criteria-card" data-dimension="${dimension}">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="flex-grow-1">
                    <div class="d-flex align-items-center gap-2 mb-2">
                      <span class="type-badge ${typeClass}">${c.type}</span>
                      <strong>${c.name}</strong>
                    </div>
                    <p class="text-muted mb-3">${c.description||''}</p>
                  </div>
                  <div class="rating-buttons">
                    ${[1,2,3,4,5].map(r => `
                      <button class="rating-btn" onclick="setRating(${c.id}, ${r})"
                              data-criteria="${c.id}" data-rating="${r}">
                        ${r}
                      </button>`).join('')}
                  </div>
                </div>
              </div>`;
          });
          section.innerHTML = html;
          container.appendChild(section);
        });
      } catch (e) {
        console.error(e);
        alert('Erro ao carregar crit√©rios de avalia√ß√£o');
      }
    }

    /* -------- Metas -------- */
    async function loadGoals() {
      try {
        if (!currentEmployee) return;
        const container = qs('#goals-container');
        container.innerHTML = '';
        updateGoalsWeight();
        calculateFinalRating();
      } catch (e) {
        console.error(e);
      }
    }

    function renderGoalsFrom(goalsList) {
      const box = document.querySelector('#goals-container');
      if (!box) return;
      box.innerHTML = '';
      if (!Array.isArray(goalsList) || goalsList.length === 0) return;

      goalsList.forEach((goal, idx) => {
        const w = Number(goal.weight ?? goal.peso ?? 0);
        const r = Number(goal.rating ?? goal.nota ?? 0);
        const name = goal.name || goal.goal_name || goal.nome || '';
        const desc = goal.description || goal.goal_description || goal.descricao || '';
        const wrap = document.createElement('div');
        wrap.className = 'goal-item';
        wrap.innerHTML = `
          <div class="goal-header">
            <h4>Meta ${idx + 1}</h4>
            <div class="d-flex gap-2">
              <input type="number" id="goal-weight-${idx}" min="0" max="100"
                     value="${!Number.isNaN(w) ? w : 0}" placeholder="Peso %" />
              <button class="btn btn-danger btn-sm" onclick="removeGoal(${idx})">
                <i class="fas fa-trash me-1"></i>Excluir
              </button>
            </div>
          </div>
          <div class="goal-content">
            <input type="text" id="goal-name-${idx}" value="${name}" placeholder="Nome da Meta">
            <textarea id="goal-description-${idx}" placeholder="Descri√ß√£o da Meta">${desc}</textarea>
          </div>
          <div class="goal-criteria">
            <h5>Crit√©rios de Avalia√ß√£o:</h5>
            <div class="criteria-grid">
              ${[1,2,3,4,5].map(n => `
                <div class="criteria-item">
                  <label>Rating ${n}:</label>
                  <textarea id="goal-rating${n}-${idx}" placeholder="Descri√ß√£o do Rating ${n}" required>${goal[`rating_${n}_criteria`] || ''}</textarea>
                </div>`).join('')}
            </div>
          </div>
          <div class="goal-rating">
            <label>Rating Atual:</label>
            <select id="goal-rating-${idx}">
              <option value="">Selecione</option>
              ${[1,2,3,4,5].map(nv => `<option value="${nv}" ${nv===r ? 'selected':''}>${nv}</option>`).join('')}
            </select>
          </div>`;
        box.appendChild(wrap);
      });

      qsa('[id^="goal-weight-"]').forEach(inp => {
        inp.addEventListener('input', () => { updateGoalsWeight(); calculateFinalRating(); });
        inp.addEventListener('change', () => { updateGoalsWeight(); calculateFinalRating(); });
      });
      qsa('[id^="goal-rating-"]').forEach(sel => {
        sel.addEventListener('change', () => calculateFinalRating());
      });

      updateGoalsWeight();
      calculateFinalRating();
    }

    function addGoal() {
      const container = qs('#goals-container');
      const index = qsa('.goal-item').length;
      const el = document.createElement('div');
      el.className = 'goal-item';
      el.innerHTML = `
        <div class="goal-header">
          <h4>Meta ${index + 1}</h4>
          <div class="d-flex gap-2">
            <input type="number" id="goal-weight-${index}" min="0" max="100" value="" placeholder="Peso %">
            <button class="btn btn-danger btn-sm" onclick="removeGoal(${index})">
              <i class="fas fa-trash me-1"></i>Excluir
            </button>
          </div>
        </div>
        <div class="goal-content">
          <input type="text" id="goal-name-${index}" placeholder="Nome da Meta">
          <textarea id="goal-description-${index}" placeholder="Descri√ß√£o da Meta"></textarea>
        </div>
        <div class="goal-criteria">
          <h5>Crit√©rios de Avalia√ß√£o:</h5>
          <div class="criteria-grid">
            ${[1,2,3,4,5].map(n => `
              <div class="criteria-item">
                <label>Rating ${n}:</label>
                <textarea id="goal-rating${n}-${index}" placeholder="Descri√ß√£o do Rating ${n}" required></textarea>
              </div>`).join('')}
          </div>
        </div>
        <div class="goal-rating">
          <label>Rating Atual:</label>
          <select id="goal-rating-${index}">
            <option value="">Selecione</option>
            ${[1,2,3,4,5].map(n => `<option value="${n}">${n}</option>`).join('')}
          </select>
        </div>`;
      container.appendChild(el);

      qs(`#goal-weight-${index}`).addEventListener('input', () => { updateGoalsWeight(); calculateFinalRating(); });
      qs(`#goal-weight-${index}`).addEventListener('change', () => { updateGoalsWeight(); calculateFinalRating(); });
      qs(`#goal-rating-${index}`).addEventListener('change', () => calculateFinalRating());
      updateGoalsWeight();
    }

    function removeGoal(goalIndex) {
      const goals = qsa('.goal-item');
      if (goals.length > 0 && goalIndex >= 0 && goalIndex < goals.length) {
        goals[goalIndex].remove();
        const remainingGoals = qsa('.goal-item');
        remainingGoals.forEach((goal, newIndex) => {
          const weightInput = goal.querySelector(`[id^="goal-weight-"]`);
          const nameInput = goal.querySelector(`[id^="goal-name-"]`);
          const descTextarea = goal.querySelector(`[id^="goal-description-"]`);
          const ratingSelect = goal.querySelector(`[id^="goal-rating-"]`);
          if (weightInput) weightInput.id = `goal-weight-${newIndex}`;
          if (nameInput) nameInput.id = `goal-name-${newIndex}`;
          if (descTextarea) descTextarea.id = `goal-description-${newIndex}`;
          if (ratingSelect) ratingSelect.id = `goal-rating-${newIndex}`;
          for (let n = 1; n <= 5; n++) {
            const criteriaTextarea = goal.querySelector(`[id^="goal-rating${n}-"]`);
            if (criteriaTextarea) criteriaTextarea.id = `goal-rating${n}-${newIndex}`;
          }
          const title = goal.querySelector('h4');
          if (title) title.textContent = `Meta ${newIndex + 1}`;
          const deleteBtn = goal.querySelector('button[onclick*="removeGoal"]');
          if (deleteBtn) deleteBtn.setAttribute('onclick', `removeGoal(${newIndex})`);
        });
        updateGoalsWeight();
        calculateFinalRating();
      }
    }

    function readGoalsFromDOM() {
      const items = qsa('.goal-item');
      const goals = [];
      let missingCriteria = false;
    
      let totalWeight = 0;        // soma dos pesos digitados (para validar 100%)
      let totalWeightRated = 0;   // soma dos pesos das metas que t√™m nota
      let weightedSum = 0;        // soma (nota * peso)
      const ratingsSimple = [];   // para fallback, se n√£o tiver peso v√°lido
    
      items.forEach((item, idx) => {
        if (!item.parentNode) return;
    
        const weightVal = toNumber(qs(`#goal-weight-${idx}`)?.value, 0);
        const ratingVal = toNumber(qs(`#goal-rating-${idx}`)?.value, null);
    
        const goal = {
          index: idx + 1,
          name: qs(`#goal-name-${idx}`)?.value || '',
          description: qs(`#goal-description-${idx}`)?.value || '',
          weight: weightVal,
          rating: ratingVal,
        };
    
        // soma total dos pesos (para checagem 100%)
        totalWeight += weightVal;
    
        // s√≥ entra no c√°lculo da m√©dia se tiver nota
        if (ratingVal != null && ratingVal > 0) {
          ratingsSimple.push(ratingVal);
    
          if (weightVal > 0) {
            weightedSum += ratingVal * weightVal;
            totalWeightRated += weightVal;
          }
        }
    
        // crit√©rios de rating 1 a 5
        for (let n = 1; n <= 5; n++) {
          const t = qs(`#goal-rating${n}-${idx}`);
          const key = `rating_${n}_criteria`;
          goal[key] = t ? t.value : '';
          if (!goal[key]) missingCriteria = true;
        }
    
        goals.push(goal);
      });
    
      // m√©dia simples (fallback)
      const avgRatingSimple = ratingsSimple.length
        ? ratingsSimple.reduce((s, v) => s + v, 0) / ratingsSimple.length
        : 0;
    
      // m√©dia ponderada pelas metas que t√™m nota
      let avgRatingWeighted = 0;
      if (totalWeightRated > 0) {
        avgRatingWeighted = weightedSum / totalWeightRated;
      } else {
        // se n√£o tiver peso v√°lido, usa m√©dia simples para n√£o quebrar nada
        avgRatingWeighted = avgRatingSimple;
      }
    
      return {
        goals,
        sumWeights: totalWeight,
        avgRating: avgRatingWeighted,   // ‚Üê √© essa que o restante do sistema usa
        avgRatingSimple,                // (extra, se quiser no futuro)
        missingCriteria,
      };
    }

    function saveGoals() {
      const { goals, missingCriteria } = readGoalsFromDOM();
      if (missingCriteria) {
        alert('Preencha todos os crit√©rios (Rating 1 a 5) de todas as metas.');
        return;
      }
      localStorage.setItem('individual_goals', JSON.stringify(goals));
      alert('Metas salvas com sucesso!');
      updateGoalsWeight();
    }

    /* -------- Pesos por dimens√£o -------- */
    function initDimensionWeights() {
      ['weight-institucional','weight-funcional','weight-individual','weight-metas'].forEach(id => {
        const input = qs('#'+id);
        input.addEventListener('input', () => { updateDimensionWeights(); calculateFinalRating(); });
        input.addEventListener('change', () => { updateDimensionWeights(); calculateFinalRating(); });
      });
      updateDimensionWeights();
    }

    
    // ‚úÖ NOVA FUN√á√ÉO: Bloquear campos de peso para gestores
    function lockDimensionWeightsForManager() {
      const isManager = !!MANAGER_NAME; // Se tem manager_name na URL, √© gestor
      
      const weightInputs = [
        'weight-institucional',
        'weight-funcional', 
        'weight-individual',
        'weight-metas'
      ];
      
      weightInputs.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
          if (isManager) {
            input.readOnly = true;
            input.disabled = false; // disabled remove o estilo, readonly mant√©m
            input.style.backgroundColor = '#f5f5f5';
            input.style.cursor = 'not-allowed';
            input.title = 'Este campo s√≥ pode ser alterado pelo RH';
          } else {
            input.readOnly = false;
            input.style.backgroundColor = '';
            input.style.cursor = '';
            input.title = '';
          }
        }
      });
      
      console.log('[lockDimensionWeightsForManager] Campos bloqueados para gestor:', isManager);
    }


        
    function updateDimensionWeights() {
      const wInst = toNumber(qs('#weight-institucional').value);
      const wFunc = toNumber(qs('#weight-funcional').value);
      const wInd  = toNumber(qs('#weight-individual').value);
      const wMet  = toNumber(qs('#weight-metas').value);
      const total = wInst + wFunc + wInd + wMet;
      const span = qs('#total-weight');
      span.textContent = total.toFixed(2);
      const wrapper = span.closest('.total-weight');
      if (Math.abs(total - 100) < 0.01) wrapper.classList.remove('invalid');
      else wrapper.classList.add('invalid');
      dimensionWeights = { INSTITUCIONAL: wInst, FUNCIONAL: wFunc, INDIVIDUAL: wInd, METAS: wMet };
    }

    /* -------- Pesos das metas -------- */
    function updateGoalsWeight() {
      let total = 0;
      qsa('[id^="goal-weight-"]').forEach(input => total += toNumber(input.value));
      const box = qs('#total-goals-weight');
      box.textContent = `Total: ${total.toFixed(2)}%`;
      if (Math.abs(total - 100) < 0.01) box.classList.remove('invalid');
      else box.classList.add('invalid');
    }

    /* -------- Ratings -------- */
    function setRating(criteriaId, rating) {
      // Remove sele√ß√£o anterior
      document.querySelectorAll(`[data-criteria="${criteriaId}"]`).forEach(btn => btn.classList.remove('selected'));
      
      // Marca o bot√£o selecionado
      const sel = document.querySelector(`[data-criteria="${criteriaId}"][data-rating="${rating}"]`);
      if (sel) sel.classList.add('selected');
      
      // ‚úÖ CORRE√á√ÉO: Salvar em AMBAS as vari√°veis globais
      const cid = String(criteriaId);
      window.evaluationData = window.evaluationData || {};
      evaluationData = evaluationData || {};
      
      window.evaluationData[cid] = Number(rating);
      evaluationData[cid] = Number(rating);
      
      console.log('[setRating] Crit√©rio', cid, 'Rating', rating, 'Salvo em evaluationData');
      console.log('[setRating] evaluationData atual:', window.evaluationData);
      
      calculateFinalRating();
    }

    function calculateDimensionAverage(dimensionKey) {
      const key = (dimensionKey || '').toUpperCase();
      const cards = qsa(`[data-dimension="${key}"]`);
      let total = 0, count = 0;
      cards.forEach(card => {
        const btn = card.querySelector('.rating-btn.selected');
        if (btn) { total += toNumber(btn.dataset.rating); count++; }
      });
      return count ? (total / count) : 0;
    }
    function calculateGoalsAverage() {
      const { avgRating } = readGoalsFromDOM();
      return avgRating || 0;
    }

        
    function calculateFinalRating() {
      const institucionalAvg = calculateDimensionAverage('INSTITUCIONAL');
      const funcionalAvg     = calculateDimensionAverage('FUNCIONAL');
      const individualAvg    = calculateDimensionAverage('INDIVIDUAL');
      const metasAvg         = calculateGoalsAverage();

      const w = dimensionWeights || {
        INSTITUCIONAL: 0,
        FUNCIONAL: 0,
        INDIVIDUAL: 0,
        METAS: 0,
      };

      const final =
        (institucionalAvg * (w.INSTITUCIONAL / 100)) +
        (funcionalAvg     * (w.FUNCIONAL     / 100)) +
        (individualAvg    * (w.INDIVIDUAL    / 100)) +
        (metasAvg         * (w.METAS         / 100));

      const finalRounded = round(final || 0);

      // üîç DEBUG: s√≥ para conferirmos uma vez
      console.log('[calculateFinalRating]', {
        institucionalAvg,
        funcionalAvg,
        individualAvg,
        metasAvg,
        weights: w,
        finalRaw: final,
        finalRounded,
      });

      // Atualiza as m√©dias das dimens√µes (labels azuis)
      qs('#avg-institucional').textContent = `M√©dia: ${round(institucionalAvg) || '-'}`;
      qs('#avg-funcional').textContent     = `M√©dia: ${round(funcionalAvg) || '-'}`;
      qs('#avg-individual').textContent    = `M√©dia: ${round(individualAvg) || '-'}`;
      qs('#avg-metas').textContent         = `M√©dia: ${round(metasAvg) || '-'}`;

      // ‚úÖ Atualiza o n√∫mero grande "Rating Final"
      const finalEl = qs('#final-rating');
      if (finalEl) {
        finalEl.textContent = finalRounded ? finalRounded : '-';
      }

      // ‚úÖ E tamb√©m o campo do cabe√ßalho "Rating 2025"
      const headerRatingEl = document.getElementById('employee-rating');
      if (headerRatingEl) {
        headerRatingEl.textContent = finalRounded ? finalRounded : '-';
      }

      return finalRounded;
    }

    
    async function submitEvaluation() {
      // ============================================
      // C√ìDIGO PARA DESABILITAR BOT√ÉO E MOSTRAR "SALVANDO..."
      // ============================================
      const btnSalvar = document.getElementById('btnSalvarAvaliacao');
      const textoOriginal = btnSalvar ? btnSalvar.innerHTML : '';
      if (btnSalvar) {
        btnSalvar.disabled = true;
        btnSalvar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Salvando avalia√ß√£o...';
      }
      // ============================================
    
      const emp = window.currentEmployee || currentEmployee;
    
      // ‚úÖ CORRE√á√ÉO CR√çTICA: Validar que o employee_id est√° correto
      if (!emp || !emp.id) {
        // Reabilitar bot√£o antes de sair
        if (btnSalvar) {
          btnSalvar.disabled = false;
          btnSalvar.innerHTML = textoOriginal;
        }
        alert('ERRO: Funcion√°rio n√£o identificado. Recarregue a p√°gina.');
        return;
      }
    
      console.log('[submitEvaluation] Funcion√°rio atual:', emp.id, emp.nome);
    
      if (!emp || !emp.id) { 
        // Reabilitar bot√£o antes de sair
        if (btnSalvar) {
          btnSalvar.disabled = false;
          btnSalvar.innerHTML = textoOriginal;
        }
        alert('Nenhum funcion√°rio selecionado'); 
        return; 
      }
    
      const { goals, avgRating: metasAvg, sumWeights, missingCriteria } = readGoalsFromDOM();
      if (missingCriteria) { 
        // Reabilitar bot√£o antes de sair
        if (btnSalvar) {
          btnSalvar.disabled = false;
          btnSalvar.innerHTML = textoOriginal;
        }
        alert('Preencha os crit√©rios (Rating 1 a 5) de todas as metas.'); 
        return; 
      }
      if (Math.abs(sumWeights - 100) > 0.01) { 
        // Reabilitar bot√£o antes de sair
        if (btnSalvar) {
          btnSalvar.disabled = false;
          btnSalvar.innerHTML = textoOriginal;
        }
        alert('Os pesos das metas devem totalizar 100%.'); 
        return; 
      }
    
      const w = dimensionWeights || { INSTITUCIONAL:0, FUNCIONAL:0, INDIVIDUAL:0, METAS:0 };
      const dimensionTotal = (Number(w.INSTITUCIONAL)||0)+(Number(w.FUNCIONAL)||0)+(Number(w.INDIVIDUAL)||0)+(Number(w.METAS)||0);
      if (Math.abs(dimensionTotal - 100) > 0.01) { 
        // Reabilitar bot√£o antes de sair
        if (btnSalvar) {
          btnSalvar.disabled = false;
          btnSalvar.innerHTML = textoOriginal;
        }
        alert('Os pesos das DIMENS√ïES devem totalizar 100%.'); 
        return; 
      }
    
      const dimAvgs = {
        INSTITUCIONAL: calculateDimensionAverage('INSTITUCIONAL'),
        FUNCIONAL:     calculateDimensionAverage('FUNCIONAL'),
        INDIVIDUAL:    calculateDimensionAverage('INDIVIDUAL'),
        METAS:         metasAvg || 0
      };
      const finalRatingRaw = calculateFinalRating();
      const finalRating = (Number.isFinite(finalRatingRaw) && finalRatingRaw > 0) ? finalRatingRaw : 1;
    
      const roundCodeEl = document.getElementById('round-code');
      const roundCode = roundCodeEl ? (roundCodeEl.value || '').trim() : '';
      if (!roundCode) { 
        // Reabilitar bot√£o antes de sair
        if (btnSalvar) {
          btnSalvar.disabled = false;
          btnSalvar.innerHTML = textoOriginal;
        }
        alert('ERRO: C√≥digo da rodada n√£o definido. Contate o RH.'); 
        return; 
      }
    
      const params = new URLSearchParams(location.search);
      const managerFromUrl = params.get('manager_name') || params.get('manager') || '';
    
      const responsesObj = { ...(window.evaluationData || {}), ...(evaluationData || {}) };
      console.log('[submitEvaluation] Respostas coletadas:', responsesObj);
      const responsesArray = Object.entries(responsesObj).map(([criteria_id, rating]) => ({
        criteria_id: Number(criteria_id), rating: Number(rating)
      }));
    
      const basePayload = {
        employee_id: Number(emp.id),
        employee_name: emp.nome || emp.name || undefined,
        manager_name: managerFromUrl || emp.manager_name || undefined,
    
        evaluation_year: 2025,
        round_code: roundCode,
        evaluation_date: new Date().toISOString(),
        evaluator_id: 1,
    
        responses: responsesObj,
        evaluation_responses: responsesArray,
        responses_array: responsesArray,
        answers: responsesObj,
        answers_array: responsesArray,
        responses_json: JSON.stringify(responsesObj),
    
        goals,
        goals_average: metasAvg || 0,
        goals_json: JSON.stringify(goals),
    
        dimension_weights: {
          INSTITUCIONAL: Number(w.INSTITUCIONAL)||0,
          FUNCIONAL:     Number(w.FUNCIONAL)||0,
          INDIVIDUAL:    Number(w.INDIVIDUAL)||0,
          METAS:         Number(w.METAS)||0
        },
        dimension_averages: {
          INSTITUCIONAL: Number(dimAvgs.INSTITUCIONAL)||0,
          FUNCIONAL:     Number(dimAvgs.FUNCIONAL)||0,
          INDIVIDUAL:    Number(dimAvgs.INDIVIDUAL)||0,
          METAS:         Number(dimAvgs.METAS)||0
        },
        dimension_weights_json: JSON.stringify(w),
        dimension_averages_json: JSON.stringify(dimAvgs),
    
        final_rating: Number(finalRating)
      };
    
      // ‚úÖ NOVA ESTRAT√âGIA: Sempre buscar avalia√ß√£o existente por employee_id + round_code
      // ‚úÖ CORRE√á√ÉO: Buscar avalia√ß√£o existente APENAS para este funcion√°rio + rodada
      let existingEvalId = null;
    
      try {
        const searchUrl = `/api/evaluations/latest?employee_id=${encodeURIComponent(emp.id)}&round_code=${encodeURIComponent(roundCode)}`;
        console.log('[submitEvaluation] Buscando avalia√ß√£o para funcion√°rio:', emp.id, 'rodada:', roundCode);
    
        const searchResp = await fetch(searchUrl);
        if (searchResp.ok) {
          const searchData = await searchResp.json();
          const foundEval = searchData?.evaluation;
    
          // ‚úÖ VALIDA√á√ÉO CR√çTICA: S√≥ usar se for do mesmo funcion√°rio
          if (foundEval && foundEval.employee_id === emp.id) {
            existingEvalId = foundEval.id || foundEval.evaluation_id || null;
            console.log('[submitEvaluation] ‚úÖ Avalia√ß√£o encontrada para este funcion√°rio. ID:', existingEvalId);
          } else {
            console.log('[submitEvaluation] ‚ö†Ô∏è Avalia√ß√£o encontrada mas n√£o √© deste funcion√°rio. Ignorando.');
            existingEvalId = null;
          }
        } else {
          console.log('[submitEvaluation] Nenhuma avalia√ß√£o existente encontrada. Criando nova.');
        }
      } catch (searchError) {
        console.warn('[submitEvaluation] Erro ao buscar avalia√ß√£o existente:', searchError);
        existingEvalId = null;
      }
    
      // ‚úÖ NUNCA usar IDs salvos de outros funcion√°rios
      // Se n√£o encontrou pelo employee_id + round_code, √© nova avalia√ß√£o
    
      // ‚úÖ VALIDA√á√ÉO: Verificar se ID pertence ao funcion√°rio correto
      if (existingEvalId) {
        try {
          const checkResp = await fetch(`/api/evaluations/${existingEvalId}`);
          if (checkResp.ok) {
            const checkData = await checkResp.json();
            if (checkData.employee_id !== emp.id) {
              console.warn('[submitEvaluation] ‚ö†Ô∏è ID pertence a outro funcion√°rio! Ignorando.');
              existingEvalId = null;
            }
          }
        } catch (_) {
          existingEvalId = null;
        }
      }
    
      console.log('[submitEvaluation] ID da avalia√ß√£o a usar:', existingEvalId || 'NOVA (criar nova)');
    
      let resp = null;
      let result = null;
    
      try {
        if (existingEvalId) {
          console.log('[submitEvaluation] ATUALIZANDO avalia√ß√£o ID:', existingEvalId);
    
          try {
            const putPayload = { ...basePayload, id: existingEvalId, evaluation_id: existingEvalId };
            resp = await fetch(`/api/evaluations/${encodeURIComponent(existingEvalId)}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(putPayload)
            });
    
            if (resp.ok) {
              result = await resp.json();
              console.log('[submitEvaluation] ‚úÖ Atualizado via PUT!', result);
            } else {
              throw new Error('PUT n√£o dispon√≠vel');
            }
    
          } catch (putError) {
            console.log('[submitEvaluation] PUT falhou, tentando POST com update...');
    
            const postPayload = {
              ...basePayload,
              id: existingEvalId,
              evaluation_id: existingEvalId,
              update: true,
              action: 'update',
              replace_responses: true
            };
    
            resp = await fetch('/api/evaluations', {
              method: 'POST',
              headers: { 
                'Content-Type': 'application/json',
                'X-Update-Evaluation': 'true'
              },
              body: JSON.stringify(postPayload)
            });
    
            if (resp.ok) {
              result = await resp.json();
              console.log('[submitEvaluation] ‚úÖ Atualizado via POST!', result);
    
              if (result.id && result.id !== existingEvalId) {
                console.warn('[submitEvaluation] ‚ö†Ô∏è Backend criou NOVA avalia√ß√£o ao inv√©s de atualizar! Nova ID:', result.id);
              }
            } else {
              throw new Error('Falha ao atualizar');
            }
          }
    
        } else {
          console.log('[submitEvaluation] CRIANDO nova avalia√ß√£o...');
          resp = await fetch('/api/evaluations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(basePayload)
          });
    
          if (!resp.ok) {
            let backendMsg = '';
            try { 
              const json = await resp.json();
              backendMsg = json?.error || json?.detail || json?.message || '';
            } catch(_){}
            // Reabilitar bot√£o antes de sair
            if (btnSalvar) {
              btnSalvar.disabled = false;
              btnSalvar.innerHTML = textoOriginal;
            }
            alert('Erro ao salvar: ' + (backendMsg || `Status ${resp.status}`));
            return;
          }
    
          result = await resp.json();
          console.log('[submitEvaluation] ‚úÖ Nova avalia√ß√£o criada!', result);
        }
    
        if (!resp || !resp.ok) {
          let backendMsg = '';
          try { 
            const json = await resp.json();
            backendMsg = json?.error || json?.detail || json?.message || '';
          } catch(_){}
          if (!backendMsg) { 
            try { backendMsg = await resp.text(); } catch(_){ backendMsg = ''; } 
          }
          console.error('[submitEvaluation] erro backend:', backendMsg, 'Status:', resp?.status);
          // Reabilitar bot√£o antes de sair
          if (btnSalvar) {
            btnSalvar.disabled = false;
            btnSalvar.innerHTML = textoOriginal;
          }
          alert('Erro ao salvar: ' + (backendMsg || `Status ${resp?.status} - veja o console`));
          return;
        }
    
        if (result?.id || result?.evaluation_id) {
          const newId = result.id || result.evaluation_id;
          window.currentEvaluationId = newId;
          window.lastLoadedEvaluationId = newId;
          currentEvaluationId = newId;
          console.log('[submitEvaluation] ID atualizado para:', newId);
        }
    
        alert('Avalia√ß√£o salva com sucesso!');
        window.evaluationData = {};
        evaluationData = {};
        const sec = document.querySelector('#evaluation-section');
        if (sec) sec.style.display = 'none';
    
        // ============================================
        // REABILITAR BOT√ÉO AP√ìS SUCESSO
        // ============================================
        if (btnSalvar) {
          btnSalvar.disabled = false;
          btnSalvar.innerHTML = textoOriginal;
        }
        // ============================================
    
      } catch (e) {
        console.error('[submitEvaluation] Erro:', e);
        alert('Erro ao salvar avalia√ß√£o: ' + e.message);
    
        // ============================================
        // REABILITAR BOT√ÉO AP√ìS ERRO
        // ============================================
        if (btnSalvar) {
          btnSalvar.disabled = false;
          btnSalvar.innerHTML = textoOriginal;
        }
        // ============================================
      }
    }
        
    // ===== Sistema de Rodadas Din√¢mico =====
    function generateRoundCode(type, year) { return `${type}${year.toString()}`; }
    function getCurrentYear() { return new Date().getFullYear(); }
    function generateCurrentRoundCodes() {
      const year = getCurrentYear();
      return { start: generateRoundCode('Start', year), ir: generateRoundCode('IR', year), ye: generateRoundCode('YE', year) };
    }
    async function loadActiveRoundCode() {
      try {
        const response = await fetch('/api/system-config');
        const config = await response.json();
        const roundCodeInput = document.getElementById('round-code');
        if (roundCodeInput && config.active_round_code) {
          roundCodeInput.value = config.active_round_code;
        } else if (roundCodeInput) {
          const codes = generateCurrentRoundCodes();
          roundCodeInput.value = codes.start;
        }
      } catch (e) {
        console.error('Erro ao carregar c√≥digo da rodada:', e);
        const roundCodeInput = document.getElementById('round-code');
        if (roundCodeInput) {
          const codes = generateCurrentRoundCodes();
          roundCodeInput.value = codes.start;
        }
      }
    }

    // ===== Pesos das Dimens√µes ‚Äî centralizados pelo RH =====
    function applyDimensionWeightsToInputs(weights, lock){
      const w = {
        INSTITUCIONAL: Number(weights.INSTITUCIONAL ?? 0),
        FUNCIONAL:     Number(weights.FUNCIONAL     ?? 0),
        INDIVIDUAL:    Number(weights.INDIVIDUAL    ?? 0),
        METAS:         Number(weights.METAS         ?? 0),
      };
      const ids = {
        INSTITUCIONAL: 'weight-institucional',
        FUNCIONAL:     'weight-funcional',
        INDIVIDUAL:    'weight-individual',
        METAS:         'weight-metas'
      };
      Object.keys(ids).forEach(k=>{
        const el = document.getElementById(ids[k]);
        if (el){
          el.value   = w[k];
          el.disabled = !!lock;
          el.readOnly = !!lock;
        }
      });
      dimensionWeights = w;
      updateDimensionWeights();
      calculateFinalRating();
    }
    async function loadCentralDimensionWeights(){
      try{
        const r = await fetch('/api/dimension-weights');
        if(!r.ok) return;
        const rows = await r.json();
        const map = {INSTITUCIONAL:null,FUNCIONAL:null,INDIVIDUAL:null,METAS:null};
        rows.forEach(row=>{
          const k = String(row.dimension || row.name || '').toUpperCase().trim();
          const v = Number(row.weight);
          if(!Number.isNaN(v) && map.hasOwnProperty(k)) map[k] = v;
        });
        const complete = Object.values(map).every(v=>typeof v==='number' && v!=null);
        const total    = Object.values(map).reduce((s,v)=> s + (Number(v)||0), 0);
        if (complete){
          const lock = Math.abs(total - 100) < 0.01;
          applyDimensionWeightsToInputs(map, lock);
        }

        // ‚úÖ Bloquear campos se for gestor
        lockDimensionWeightsForManager();

          
      }catch(e){
        console.warn('Falha carregando pesos centrais:', e);
      }
    }

    // === FILTRO POR GESTOR VIA URL (?manager_name=...) ===
    function getQueryParam(name){
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }
    function renderEmployeesCards(employees){
      const wrap = document.getElementById('employees-container');
      if (!wrap) return;
      wrap.innerHTML = '';
      employees.forEach(emp => {
        const col = document.createElement('div');
        col.className = 'col-md-4';
        col.innerHTML = `
          <div class="employee-card">
            <h5 class="mb-1">${emp.nome || '-'}</h5>
            <div class="text-muted mb-2">${emp.cargo || '-'}</div>
            <div><strong>Departamento:</strong> ${emp.department_name || '-'}</div>
            <div><strong>Empresa:</strong> ${emp.empresa || emp.company_name || '-'}</div>
            <div class="mt-3 d-flex gap-2">
              <button class="btn btn-sm btn-primary" onclick="startEvaluationForEmployee(${emp.id})">Nova avalia√ß√£o</button>
              <button class="btn btn-sm btn-outline-secondary" onclick="viewEmployeeEvaluation(${emp.id})">Ver √∫ltima</button>
            </div>
          </div>`;
        wrap.appendChild(col);
      });
      const sec = document.getElementById('employees-section');
      if (sec) sec.style.display = 'block';
      const nine = document.getElementById('nine-box-section');
      if (nine) nine.style.display = 'none';
      const evalSec = document.getElementById('evaluation-section');
      if (evalSec) evalSec.style.display = 'none';
    }
    async function loadEmployeesByManager(managerName){
      try{
        const url = `/api/employees/by-manager?manager_name=${encodeURIComponent(managerName)}`;
        const r = await fetch(url);
        if (!r.ok) throw new Error('Falha ao buscar funcion√°rios do gestor');
        const data = await r.json();
        renderEmployeesCards(data || []);
      }catch(e){
        console.error(e);
        alert('Erro ao carregar equipe do gestor.');
      }
    }
    (function autoFilterByManager(){
      const m = getQueryParam('manager_name') || getQueryParam('manager');
      if (m) { loadEmployeesByManager(m); }
    })();

    

    // ===== Exporta√ß√£o global =====
    window.loadEmployees = loadEmployees;
    window.startEvaluation = startEvaluation;
    window.editEmployee = editEmployee;
    window.startEvaluationForEmployee = startEvaluationForEmployee;
    window.showNineBoxMatrix = showNineBoxMatrix;
    window.addGoal = addGoal;
    window.saveGoals = saveGoals;
    window.setRating = setRating;
    window.removeGoal = removeGoal;

    </script>

    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
    /* === VIEW (espelhado da p√°gina /manager) ===
       Abre SEMPRE a √öLTIMA avalia√ß√£o do colaborador, preenchendo:
       - Cabe√ßalho do avaliado
       - Crit√©rios marcados
       - Pesos por dimens√£o
       - Metas (se existirem)
       - C√≥digo da rodada
       Mostra a se√ß√£o de avalia√ß√£o pronta para VER/EDITAR.
    */
    window.viewEmployeeEvaluation = async function(employeeId, roundCode){
      // pega round_code da URL (no iframe) e tamb√©m aceita roundCode por par√¢metro
      const params = new URLSearchParams(window.location.search);
      const roundCodeFromUrl = (params.get("round_code") || "").trim();
    
      const requestedRoundCode =
        (roundCode != null && String(roundCode).trim())
          ? String(roundCode).trim()
          : roundCodeFromUrl;
    
      try {
        employeeId = Number(employeeId);
        console.log('[viewEmployeeEvaluation] employeeId=', employeeId, 'requestedRoundCode=', requestedRoundCode, 'search=', window.location.search);
    
        if (!employeeId) { alert('ID de colaborador inv√°lido.'); return; }
    
        // 1) Buscar avalia√ß√£o (se vier requestedRoundCode, tenta esse ciclo; sen√£o, pega a √∫ltima)

    
        // 1) Buscar avalia√ß√£o (se vier round_code, tenta esse ciclo; sen√£o, pega a √∫ltima)
        const qs = new URLSearchParams();
        qs.set("employee_id", String(employeeId));
        
        // requestedRoundCode √© opcional (ex: "YE2025")
        if (requestedRoundCode) qs.set("round_code", String(requestedRoundCode));

        
        const rEval = await fetch('/api/evaluations/latest?' + qs.toString());
        
        // ‚úÖ SEM FALLBACK quando round_code foi pedido:
        // se n√£o existir avalia√ß√£o naquele ciclo, N√ÉO pode abrir a "√∫ltima"
        if (!rEval.ok) {
          if (rEval.status === 404) {
            alert(requestedRoundCode
              ? `Nenhuma avalia√ß√£o encontrada para este colaborador no ciclo ${requestedRoundCode}.`
              : 'Nenhuma avalia√ß√£o encontrada para este colaborador.'
            );
            return;
          }
          alert('Erro ao carregar a avalia√ß√£o.');
          return;
        }
        
        const { evaluation: ev, responses, weights, goals } = await rEval.json();
        const evalId = ev?.id || ev?.evaluation_id || null;
        window.lastLoadedEvaluationId = evalId;
        window.currentEvaluationId = evalId;
        try { currentEvaluationId = evalId; } catch (_) {}




          
        // 2) Buscar dados do colaborador para o cabe√ßalho
        let employee = null;
        try {
          const rEmp = await fetch('/api/employees');
          const list = await rEmp.json();
          employee = Array.isArray(list) ? list.find(e => Number(e.id) === Number(ev.employee_id)) : null;
        } catch (_) {}
    
        // ‚úÖ CORRE√á√ÉO: Definir currentEmployee GLOBALMENTE
        if (employee) {
          window.currentEmployee = employee;
          currentEmployee = employee;
        } else {
          const stub = {
            id: ev.employee_id, 
            nome: 'ID ' + ev.employee_id, 
            cargo: '-', 
            empresa: '-',
            department_name: '-', 
            branch_name: '-', 
            admission_date: null, 
            manager_name: '-',
            birth_date: null, 
            employment_status: 'ATIVO', 
            leave_reason: '', 
            salario: null
          };
          window.currentEmployee = stub;
          currentEmployee = stub;
        }
    
        // 3) Preencher cabe√ßalho
        if (typeof window.setEmployeeHeader === 'function') {
          window.setEmployeeHeader(currentEmployee, ev?.final_rating ?? null);
          const idEl = document.getElementById('employee-id');
          if (idEl && typeof window.fmtEmpCode === 'function') {
            idEl.textContent = window.fmtEmpCode(currentEmployee);
          }
        }
    
        // 4) Carregar crit√©rios na tela
        if (typeof window.loadEvaluationCriteria === 'function') {
          await window.loadEvaluationCriteria();
        }
    
        // 5) Marcar respostas crit√©rio a crit√©rio
        window.evaluationData = {};
        evaluationData = {};
        
        console.log('[viewEmployeeEvaluation] Total de respostas recebidas:', responses?.length || 0);
        
        // ‚úÖ CORRE√á√ÉO: Filtrar apenas as respostas mais recentes de cada crit√©rio
        let latestResponses = {};
        if (Array.isArray(responses) && responses.length > 0) {
          responses.forEach(row => {
            const cid = String(row.criteria_id || row.criteriaId || row.id);
            const rating = Number(row.rating || row.value);
            const rowId = Number(row.id || 0);
            
            if (!cid || !rating) return;
            
            // Se n√£o tem essa resposta ainda, ou se esta √© mais recente (id maior)
            if (!latestResponses[cid] || rowId > (latestResponses[cid].id || 0)) {
              latestResponses[cid] = {
                criteria_id: cid,
                rating: rating,
                id: rowId
              };
            }
          });
          
          console.log('[viewEmployeeEvaluation] Respostas filtradas (√∫ltimas por crit√©rio):', Object.keys(latestResponses).length);
          console.log('[viewEmployeeEvaluation] √öltimas respostas:', latestResponses);
        }
        
        // ‚úÖ CORRE√á√ÉO: Aguardar mais tempo e garantir que os bot√µes existam
        let attempts = 0;
        const maxAttempts = 10;
        
        const markRatings = () => {
          let allFound = true;
          
          Object.values(latestResponses).forEach(row => {
            const cid = String(row.criteria_id);
            const r = Number(row.rating);
            
            // Remove sele√ß√£o anterior
            document.querySelectorAll(`[data-criteria="${cid}"]`).forEach(b => {
              b.classList.remove('selected');
            });
            
            // Marca o bot√£o correto
            const btn = document.querySelector(`[data-criteria="${cid}"][data-rating="${r}"]`);
            if (btn) {
              btn.classList.add('selected');
              window.evaluationData[cid] = r;
              evaluationData[cid] = r;
            } else {
              allFound = false;
            }
          });
          
          if (!allFound && attempts < maxAttempts) {
            attempts++;
            setTimeout(markRatings, 100);
          } else {
            console.log('[viewEmployeeEvaluation] evaluationData ap√≥s carregar:', window.evaluationData);
          }
        };
        
        // Aguardar um pouco antes de come√ßar
        await new Promise(resolve => setTimeout(resolve, 300));
        markRatings();

          
        // 6) Pesos por dimens√£o (usa o que veio salvo)
        const norm = (typeof window.normalizeDimensionWeights === 'function')
          ? window.normalizeDimensionWeights(weights || ev?.dimension_weights || {})
          : (weights || ev?.dimension_weights || {INSTITUCIONAL:0,FUNCIONAL:0,INDIVIDUAL:0,METAS:0});
    
        dimensionWeights = norm; // ‚úÖ CORRE√á√ÉO: Atualizar dimensionWeights global
        
        const wi = document.getElementById('weight-institucional');
        const wf = document.getElementById('weight-funcional');
        const wn = document.getElementById('weight-individual');
        const wm = document.getElementById('weight-metas');
        if (wi) wi.value = norm.INSTITUCIONAL ?? 0;
        if (wf) wf.value = norm.FUNCIONAL ?? 0;
        if (wn) wn.value = norm.INDIVIDUAL ?? 0;
        if (wm) wm.value = norm.METAS ?? 0;
        
        if (typeof window.updateDimensionWeights === 'function') window.updateDimensionWeights();
        // ‚úÖ Bloquear campos se for gestor
        lockDimensionWeightsForManager();
        
        // 7) Metas (se existirem) ‚Äî SEMPRE filtrar pelo ciclo pedido
        let goalsList = goals;
        console.log('[goals][RAW] goals=', goals);
        console.log('[goals][RAW] sample=', Array.isArray(goals) ? goals[0] : goals, 'keys=', (Array.isArray(goals) && goals[0]) ? Object.keys(goals[0]) : []);

        
        // tenta completar goalsList a partir das outras fontes (igual voc√™ j√° fazia)
        if ((!Array.isArray(goalsList) || !goalsList.length) && ev?.goals_json) {
          try { goalsList = JSON.parse(ev.goals_json); } catch {}
        }
        if ((!Array.isArray(goalsList) || !goalsList.length) && ev?.goals) {
          goalsList = ev.goals;
        }
        
        // --- FILTRO ROBUSTO POR ROUND_CODE (YE2025 / Start2026) ---
        const normRC = (v) => String(v ?? '').trim().toLowerCase();
        const wantedRC = normRC(requestedRoundCode || ev?.round_code);
        
        if (Array.isArray(goalsList) && wantedRC) {
          // pega round_code de qualquer formato que possa vir do backend
          goalsList = goalsList.filter(g => {
            const rc = normRC(g?.round_code ?? g?.roundCode ?? g?.cycle ?? g?.round);
            return rc === wantedRC;
          });
        }
        
        console.log('[goals] requestedRoundCode=', requestedRoundCode, 'wantedRC=', wantedRC, 'qtd=', Array.isArray(goalsList) ? goalsList.length : 0, goalsList);
        
        // render
        const goalsBox = document.querySelector('#goals-container');
        if (goalsBox) {
          if (Array.isArray(goalsList) && goalsList.length && typeof window.renderGoalsFrom === 'function') {
            window.renderGoalsFrom(goalsList);
          } else {
            goalsBox.innerHTML = ''; // sem metas para este ciclo
            if (typeof window.updateGoalsWeight === 'function') window.updateGoalsWeight();
          }
        }


    
        // 8) C√≥digo da rodada ‚Äî SEMPRE preencher no modo consulta/ciclo
        const roundCodeInput = document.getElementById('round-code');
        if (roundCodeInput) {
          const rc = (ev?.round_code || requestedRoundCode || "").toString();
          roundCodeInput.value = rc;
        
          // se estiver em readonly, n√£o tenta ‚Äúrodada ativa‚Äù
          const urlMode = (new URLSearchParams(window.location.search).get("mode") || "").toLowerCase();
          if (!rc && urlMode !== "readonly" && typeof window.loadActiveRoundCode === "function") {
            await window.loadActiveRoundCode();
          }
        }

    
        // 9) Recalcular/mostrar rating final
        if (typeof window.calculateFinalRating === 'function') window.calculateFinalRating();
    
        // 10) Mostrar se√ß√£o
        const sec = document.getElementById('evaluation-section');
        if (sec) { sec.style.display = 'block'; sec.scrollIntoView({behavior:'smooth'}); }
        
        console.log('[viewEmployeeEvaluation] Avalia√ß√£o carregada com sucesso. ID:', evalId);
      } catch(e) {
        console.error('[viewEmployeeEvaluation] Erro:', e);
        alert('Falha ao abrir a avalia√ß√£o: ' + e.message);
      }
    };

    // =======================
    // MODO SOMENTE LEITURA (consulta) ‚Äî trava UI quando ?mode=readonly
    // =======================
    (function () {
      function isReadonlyMode() {
        const qs = new URLSearchParams(window.location.search || "");
        return (qs.get("mode") || "").toLowerCase() === "readonly";
      }
    
      function lockReadonlyUIOnce() {
        if (!isReadonlyMode()) return;
    
        const sec = document.getElementById("evaluation-section") || document.body;
    
        // Banner discreto
        if (!document.getElementById("readonly-banner")) {
          const b = document.createElement("div");
          b.id = "readonly-banner";
          b.textContent = "Modo consulta (somente leitura)";
          b.style.padding = "10px 12px";
          b.style.margin = "10px 0";
          b.style.border = "1px solid #e5e7eb";
          b.style.borderRadius = "12px";
          b.style.background = "#fafafa";
          b.style.fontWeight = "800";
          sec.prepend(b);
        }
    
        // 1) Desabilita campos (continua dando para rolar a tela normalmente)
        sec.querySelectorAll("input, select, textarea").forEach(el => {
          try {
            el.readOnly = true;
            el.disabled = true;
          } catch (_) {}
        });
    
        // 2) Desabilita bot√µes de rating (data-criteria / data-rating)
        sec.querySelectorAll("[data-criteria][data-rating]").forEach(el => {
          el.style.pointerEvents = "none";
        });
    
        // 3) Esconde bot√µes perigosos (Salvar / Nova avalia√ß√£o / Adicionar meta etc.)
        const killWords = [
          "salvar",
          "salvar avalia√ß√£o",
          "nova avalia√ß√£o",
          "criar avalia√ß√£o",
          "adicionar meta",
          "adicionar",
          "excluir",
          "remover",
          "concluir",
          "enviar"
        ];
    
        sec.querySelectorAll("button, a").forEach(el => {
          const txt = (el.textContent || "").trim().toLowerCase();
          if (killWords.some(w => txt.includes(w))) {
            el.style.display = "none";
          } else {
            // mesmo os que n√£o escondemos, n√£o podem clicar
            el.style.pointerEvents = "none";
          }
        });
      }
    
      // Como a tela monta aos poucos, aplicamos algumas vezes e paramos
      function lockReadonlyUIWithRetries() {
        if (!isReadonlyMode()) return;
    
        let tries = 0;
        const maxTries = 25; // ~12s
        const t = setInterval(() => {
          tries++;
          lockReadonlyUIOnce();
          if (tries >= maxTries) clearInterval(t);
        }, 500);
      }
    
      // roda ao carregar
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", lockReadonlyUIWithRetries);
      } else {
        lockReadonlyUIWithRetries();
      }
    
      // Tamb√©m roda depois que ‚ÄúviewEmployeeEvaluation‚Äù carregar algo (se existir)
      const _old = window.viewEmployeeEvaluation;
      if (typeof _old === "function") {
        window.viewEmployeeEvaluation = async function (...args) {
          const ret = await _old.apply(this, args);
          lockReadonlyUIWithRetries();
          return ret;
        };
      }
    })();

  
   /* Autoabrir avalia√ß√£o quando vier por URL:
   ?employee_id=149&open=latest
   ?employee_id=149&open=cycle&round_code=YE2025
*/
    (function autoOpenEvaluationFromUrl(){
      const params = new URLSearchParams(window.location.search);
    
      const employeeId = Number(params.get("employee_id") || 0);
      const open = (params.get("open") || "").toLowerCase();
      const roundCode = (params.get("round_code") || "").trim();
    
      if (!employeeId) return;
      if (open !== "latest" && open !== "cycle") return;
    
      const tryOpen = () => {
        if (typeof window.viewEmployeeEvaluation === "function") {
          window.viewEmployeeEvaluation(employeeId, roundCode || undefined);
        } else {
          setTimeout(tryOpen, 200);
        }
      };
    
      tryOpen();
    })();
    




        
    


    /* ===== READONLY (hist√≥rico via iframe): esconder a√ß√µes perigosas ===== */
    (function applyReadonlyUI(){
      try {
        const qs = new URLSearchParams(window.location.search);
        const mode = (qs.get("mode") || "").toLowerCase();
        if (mode !== "readonly") return; // <- N√ÉO afeta as outras p√°ginas normais
    
        const hide = (el) => {
          if (!el) return;
          el.style.display = "none";
          el.setAttribute("aria-hidden", "true");
        };
    
        // 1) Esconde por texto (funciona mesmo se n√£o tiver id)
        const killWords = [
          "nova avalia√ß√£o",
          "nova avaliacao",
          "9 box",
          "9box",
          "nine box",
          "ninebox"
        ];
    
        document.querySelectorAll("button,a").forEach((el) => {
          const t = (el.textContent || "").trim().toLowerCase();
          if (!t) return;
          if (killWords.some((w) => t.includes(w))) hide(el);
        });
    
        // 2) Esconde por onclick (caso exista)
        document.querySelectorAll("[onclick]").forEach((el) => {
          const oc = (el.getAttribute("onclick") || "").toLowerCase();
          if (oc.includes("ninebox") || oc.includes("9box") || oc.includes("new") || oc.includes("nova")) {
            // s√≥ remove se for claramente a√ß√£o de navega√ß√£o/cria√ß√£o
            // (se quiser, eu deixo mais ‚Äúcir√∫rgico‚Äù depois)
            hide(el);
          }
        });
    
        // 3) (Opcional) trava tamb√©m bot√µes de salvar dentro do readonly
        document.querySelectorAll("button").forEach((el) => {
          const t = (el.textContent || "").trim().toLowerCase();
          if (t.includes("salvar") || t.includes("save")) hide(el);
        });
    
        console.log("[readonly] UI actions hidden");
      } catch (e) {
        console.warn("[readonly] applyReadonlyUI error", e);
      }
    })();



        
    </script>

    
</body>
</html>
